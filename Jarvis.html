<!DOCTYPE html><html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'><title>Jarvis</title><script src='ds.js'></script>
    <style>
        /* ========== ORIGINAL CSS â€“ COMPLETELY PRESERVED ========== */
        :root {
            --primary-bg: #0f0b1f;
            --secondary-bg: #1a152f;
            --tertiary-bg: #25203f;
            --card-bg: rgba(30, 25, 50, 0.95);
            --glass-bg: rgba(40, 35, 70, 0.7);
            --input-bg: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: #c0c8ff;
            --text-muted: #8a94d0;
            --text-accent: #a78bfa;
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            --accent-pink: #ec4899;
            --accent-green: #10b981;
            --accent-orange: #f97316;
            --accent-yellow: #fbbf24;
            --accent-cyan: #06b6d4;
            --gradient-primary: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            --gradient-secondary: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            --gradient-accent: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 8px 30px rgba(0,0,0,0.3);
            --shadow-lg: 0 20px 60px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 40px rgba(139,92,246,0.3);
            --shadow-neon: 0 0 30px rgba(139,92,246,0.5);
            --radius-sm: 12px;
            --radius-md: 20px;
            --radius-lg: 28px;
            --radius-xl: 36px;
            --radius-full: 9999px;
            --transition-fast: all 0.2s cubic-bezier(0.4,0,0.2,1);
            --transition-normal: all 0.3s cubic-bezier(0.4,0,0.2,1);
            --transition-slow: all 0.5s cubic-bezier(0.4,0,0.2,1);
            --sidebar-width: 280px;
            --header-height: 70px;
            --animation-speed: 1;
        }
        .light-theme {
            --primary-bg: #f8fafc;
            --secondary-bg: #f1f5f9;
            --tertiary-bg: #e2e8f0;
            --card-bg: rgba(255,255,255,0.95);
            --glass-bg: rgba(255,255,255,0.8);
            --input-bg: rgba(0,0,0,0.05);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-accent: #7c3aed;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-glow: 0 0 20px rgba(124,58,237,0.2);
        }
        .light-theme .background-effects {
            background: radial-gradient(circle at 20% 30%, rgba(124,58,237,0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(59,130,246,0.1) 0%, transparent 50%),
                        linear-gradient(180deg, rgba(248,250,252,0.9), rgba(241,245,249,0.9));
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            font-size: 15px;
            font-weight: 400;
            transition: background var(--transition-normal), color var(--transition-normal);
        }
        .background-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            background: radial-gradient(circle at 20% 30%, rgba(139,92,246,0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(59,130,246,0.15) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(236,72,153,0.1) 0%, transparent 50%),
                        linear-gradient(180deg, rgba(15,11,31,0.9), rgba(26,21,47,0.9));
        }
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        .particle {
            position: absolute;
            background: var(--accent-purple);
            border-radius: 50%;
            opacity: 0.3;
            animation: float calc(20s / var(--animation-speed)) infinite linear;
        }
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            width: 100%;
            overflow-x: hidden;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: var(--secondary-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 100;
            transform: translateX(-100%);
            transition: transform var(--transition-slow);
            overflow: hidden;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: margin var(--transition-normal);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
            overflow-x: hidden;
        }
        .sidebar.open ~ .main-content {
            margin-left: var(--sidebar-width);
        }
        .header {
            height: var(--header-height);
            padding: 0 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 90;
            width: 100%;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .menu-toggle {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--input-bg);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 20px;
        }
        .menu-toggle:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--accent-purple);
            transform: rotate(90deg);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo-icon {
            width: 44px;
            height: 44px;
            background: var(--gradient-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 900;
            box-shadow: var(--shadow-glow);
            color: white;
        }
        .logo-text h1 {
            font-size: 22px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        .logo-text .subtitle {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--input-bg);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 18px;
            position: relative;
        }
        .header-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--accent-purple);
            transform: translateY(-2px);
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 18px;
            background: rgba(16,185,129,0.1);
            border-radius: var(--radius-md);
            border: 1px solid rgba(16,185,129,0.3);
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 20px var(--accent-green);
            animation: pulse calc(2s / var(--animation-speed)) infinite;
        }
        .sidebar-header {
            padding: 32px 24px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .user-avatar {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-md);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 900;
            box-shadow: var(--shadow-glow);
            color: white;
        }
        .user-info h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .user-info p {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .sidebar-nav {
            flex: 1;
            padding: 24px 0;
            overflow-y: auto;
        }
        .nav-section {
            margin-bottom: 32px;
        }
        .nav-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
            padding: 0 24px;
        }
        .nav-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition-fast);
            cursor: pointer;
            border-left: 4px solid transparent;
            font-weight: 500;
        }
        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }
        .nav-item.active {
            background: rgba(139,92,246,0.1);
            color: var(--accent-purple);
            border-left-color: var(--accent-purple);
        }
        .nav-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
            opacity: 0.8;
        }
        .badge {
            background: var(--accent-purple);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            margin-left: auto;
        }
        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 24px;
            overflow: hidden;
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }
        .message {
            display: flex;
            gap: 20px;
            animation: fadeIn calc(0.3s * var(--animation-speed)) ease;
            max-width: 100%;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 900;
            flex-shrink: 0;
            margin-top: 4px;
            color: white;
        }
        .message.assistant .message-avatar {
            background: var(--gradient-primary);
            box-shadow: var(--shadow-glow);
        }
        .message.user .message-avatar {
            background: var(--tertiary-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }
        .message-content {
            max-width: 85%;
            padding: 20px;
            border-radius: var(--radius-lg);
            position: relative;
            word-wrap: break-word;
            line-height: 1.7;
        }
        .message.assistant .message-content {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 4px solid var(--accent-purple);
        }
        .message.user .message-content {
            background: rgba(139,92,246,0.15);
            border: 1px solid rgba(139,92,246,0.3);
            border-right: 4px solid var(--accent-purple);
        }
        .message-text {
            font-size: 15px;
            line-height: 1.7;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
        .message-text p {
            margin-bottom: 12px;
        }
        .message-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 12px;
            text-align: right;
        }
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            opacity: 0;
            transition: var(--transition-fast);
        }
        .message-content:hover .message-actions {
            opacity: 1;
        }
        .message-action-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--input-bg);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 14px;
        }
        .message-action-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }
        .input-container {
            padding: 24px 0;
            position: sticky;
            bottom: 0;
            background: var(--primary-bg);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .input-wrapper {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }
        #messageInput, #chatInput, #ollamaInput {
            width: 100%;
            min-height: 60px;
            max-height: 200px;
            padding: 20px 70px 20px 24px;
            background: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            resize: none;
            transition: var(--transition-normal);
            line-height: 1.6;
        }
        #messageInput:focus, #chatInput:focus, #ollamaInput:focus {
            outline: none;
            border-color: var(--accent-purple);
            background: rgba(255,255,255,0.12);
            box-shadow: 0 0 0 4px rgba(139,92,246,0.1);
        }
        .input-buttons {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
        }
        .send-btn, .voice-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .send-btn {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow);
        }
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139,92,246,0.4);
        }
        .voice-btn {
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--input-bg);
            color: var(--text-primary);
        }
        .voice-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--accent-pink);
        }
        .voice-btn.listening {
            background: var(--accent-pink);
            color: white;
            animation: pulse calc(1.5s / var(--animation-speed)) infinite;
        }
        .quick-actions-section {
            padding: 24px;
            background: var(--secondary-bg);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }
        .quick-action {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            cursor: pointer;
            transition: var(--transition-normal);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            text-align: center;
        }
        .quick-action:hover {
            transform: translateY(-4px);
            border-color: var(--accent-purple);
            box-shadow: var(--shadow-md);
        }
        .quick-action-icon {
            font-size: 28px;
            width: 60px;
            height: 60px;
            background: rgba(139,92,246,0.1);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
        }
        .quick-action-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn calc(0.3s * var(--animation-speed)) ease;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-container {
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            padding: 40px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-lg);
            position: relative;
            animation: modalSlideIn calc(0.4s * var(--animation-speed)) cubic-bezier(0.4,0,0.2,1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .modal-close {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--input-bg);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 20px;
        }
        .modal-close:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--accent-pink);
            transform: rotate(90deg);
        }
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .toast {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition-normal);
            max-width: 400px;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        .toast.success {
            border-left: 4px solid var(--accent-green);
        }
        .toast.error {
            border-left: 4px solid var(--accent-pink);
        }
        .toast.warning {
            border-left: 4px solid var(--accent-orange);
        }
        .toast.info {
            border-left: 4px solid var(--accent-blue);
        }
        @keyframes fadeIn {
            from { opacity:0; transform:translateY(20px); }
            to { opacity:1; transform:translateY(0); }
        }
        @keyframes modalSlideIn {
            from { opacity:0; transform:translateY(-40px) scale(0.95); }
            to { opacity:1; transform:translateY(0) scale(1); }
        }
        @keyframes float {
            0%,100% { transform:translateY(0) rotate(0deg); }
            50% { transform:translateY(-20px) rotate(180deg); }
        }
        @keyframes pulse {
            0%,100% { opacity:1; transform:scale(1); }
            50% { opacity:0.7; transform:scale(1.05); }
        }
        @keyframes spin {
            from { transform:rotate(0deg); }
            to { transform:rotate(360deg); }
        }
        @keyframes typing {
            0%,100% { transform:scale(1); }
            50% { transform:scale(1.2); }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--accent-purple);
            animation: spin calc(1s / var(--animation-speed)) ease-in-out infinite;
        }
        .typing-indicator {
            display: flex;
            gap: 8px;
            padding: 16px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-purple);
            animation: typing calc(1.4s / var(--animation-speed)) infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 4px;
        }
        .form-group {
            margin-bottom: 24px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 16px;
            background: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 15px;
            transition: var(--transition-fast);
            font-family: 'Inter', sans-serif;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(139,92,246,0.1);
        }
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139,92,246,0.4);
        }
        .btn-secondary {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--accent-purple);
        }
        .btn-sm {
            padding: 10px 20px;
            font-size: 14px;
        }
        .w-full {
            width: 100%;
        }
        .hidden {
            display: none !important;
        }
        .flex {
            display: flex;
        }
        .gap-4 {
            gap: 16px;
        }
        .mt-4 {
            margin-top: 16px;
        }
        .mt-6 {
            margin-top: 24px;
        }
        .text-center {
            text-align: center;
        }
        .text-sm {
            font-size: 14px;
        }
        .text-xs {
            font-size: 12px;
        }
        .text-muted {
            color: var(--text-muted);
        }
        .text-secondary {
            color: var(--text-secondary);
        }
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15,11,31,0.98);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .auth-container {
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            padding: 48px;
            width: 90%;
            max-width: 440px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            animation: modalSlideIn calc(0.5s * var(--animation-speed)) ease-out;
        }
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        .auth-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 28px;
            font-size: 32px;
            font-weight: 900;
            box-shadow: var(--shadow-glow);
            animation: float calc(3s / var(--animation-speed)) ease-in-out infinite;
            color: white;
        }
        .auth-title {
            font-size: 28px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }
        .auth-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .app-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition-normal);
            cursor: pointer;
            text-align: center;
        }
        .app-card:hover {
            border-color: var(--accent-purple);
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }
        .app-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        .app-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .app-category {
            font-size: 12px;
            color: var(--text-muted);
            background: rgba(255,255,255,0.05);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            display: inline-block;
        }
        .commands-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .command-item {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition-fast);
        }
        .command-item:hover {
            border-color: var(--accent-purple);
        }
        .command-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .command-icon {
            font-size: 20px;
            width: 40px;
            height: 40px;
            background: rgba(139,92,246,0.1);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .command-actions {
            display: flex;
            gap: 8px;
        }
        .routines-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .routine-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition-fast);
        }
        .routine-card:hover {
            border-color: var(--accent-purple);
        }
        .routine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .routine-title {
            font-size: 18px;
            font-weight: 700;
        }
        .routine-trigger {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .routine-actions-list {
            list-style: none;
            padding-left: 0;
        }
        .routine-actions-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        /* ========== NEW STYLES FOR SUPER TOOLS, ANDROID, OLLAMA, CONTACTS ========== */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .tool-card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 16px;
            cursor: pointer;
            transition: var(--transition-fast);
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .tool-card:hover {
            border-color: var(--accent-purple);
            transform: scale(0.98);
        }
        .tool-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        .tool-name {
            font-size: 13px;
            font-weight: 600;
        }
        .quick-notes-list, .alarms-list, .reminders-list, .contacts-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }
        .note-item, .alarm-item, .reminder-item, .contact-item {
            background: var(--input-bg);
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .memory-game {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 16px;
        }
        .memory-card {
            aspect-ratio: 1;
            background: var(--accent-purple);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .memory-card.flipped {
            background: var(--accent-green);
        }
        .tic-tac-toe {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 200px;
            margin: 0 auto;
        }
        .ttt-cell {
            aspect-ratio: 1;
            background: var(--input-bg);
            border: 1px solid var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
        }
        .stopwatch-display {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            font-family: monospace;
            margin: 20px 0;
        }
        .calculator-display {
            background: var(--input-bg);
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: right;
            font-size: 28px;
            margin-bottom: 16px;
        }
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4,1fr);
            gap: 8px;
        }
        .color-preview {
            width: 100%;
            height: 60px;
            border-radius: var(--radius-md);
            margin-top: 8px;
        }
        .qr-canvas {
            display: block;
            margin: 16px auto;
            background: white;
            padding: 16px;
            border-radius: var(--radius-md);
        }
        .android-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .android-card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 16px;
            cursor: pointer;
            transition: var(--transition-fast);
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .android-card:hover {
            border-color: var(--accent-green);
            transform: scale(0.98);
        }
        .android-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        .android-name {
            font-size: 13px;
            font-weight: 600;
        }
        /* Incoming call UI */
        .incoming-call-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        .incoming-call-card {
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            padding: 40px;
            text-align: center;
            border: 2px solid var(--accent-green);
            box-shadow: var(--shadow-neon);
            max-width: 400px;
            width: 90%;
        }
        .caller-avatar {
            width: 100px;
            height: 100px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
        }
        .caller-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .caller-number {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }
        .call-actions {
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        .call-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
        }
        .accept-btn {
            background: var(--accent-green);
            color: white;
            box-shadow: 0 0 30px var(--accent-green);
        }
        .reject-btn {
            background: var(--accent-pink);
            color: white;
            box-shadow: 0 0 30px var(--accent-pink);
        }
        .call-btn:hover {
            transform: scale(1.1);
        }
        /* Multitask panel */
        .multitask-panel {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--accent-purple);
        }
        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .task-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
        }
        .task-actions button:hover {
            color: var(--accent-purple);
        }
        /* Ollama chat panel (full tab) */
        #ollama .ollama-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .ollama-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .ollama-message.user {
            align-self: flex-end;
            background: var(--accent-purple);
            color: white;
        }
        .ollama-message.assistant {
            align-self: flex-start;
            background: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .file-upload {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .file-label {
            background: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-md);
            padding: 10px 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        #ollamaFileInfo {
            color: var(--text-secondary);
            font-size: 13px;
        }
        /* Contacts */
        .contacts-upload {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        /* ========== MOBILE RESPONSIVENESS ENHANCEMENTS ========== */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }
            .header-right {
                gap: 8px;
            }
            .header-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            .status-indicator span {
                display: none;
            }
            .status-indicator {
                padding: 8px 12px;
            }
            .logo-text .subtitle {
                display: none;
            }
            .logo-text h1 {
                font-size: 18px;
            }
            .chat-container {
                padding: 16px;
            }
            .message-content {
                max-width: 90%;
                padding: 16px;
            }
            .modal-container {
                padding: 24px;
                width: 95%;
            }
            .actions-grid,
            .tools-grid,
            .android-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .quick-action,
            .tool-card,
            .android-card {
                padding: 16px;
            }
            .quick-action-icon {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .section-header .flex {
                width: 100%;
                flex-wrap: wrap;
            }
            #ollamaModelSelect {
                width: 100% !important;
                margin-bottom: 8px;
            }
        }
        @media (max-width: 480px) {
            .actions-grid,
            .tools-grid,
            .android-grid {
                grid-template-columns: 1fr;
            }
            .header-left .logo {
                gap: 8px;
            }
            .menu-toggle {
                width: 40px;
                height: 40px;
            }
            .logo-icon {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            .input-buttons {
                right: 8px;
            }
            .send-btn, .voice-btn {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }
            #messageInput, #chatInput, #ollamaInput {
                padding: 16px 60px 16px 16px;
                min-height: 52px;
            }
            .toast {
                max-width: 90%;
                padding: 12px 16px;
            }
            .incoming-call-card {
                padding: 24px;
            }
            .caller-name {
                font-size: 22px;
            }
            .call-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
        }
        /* Customization extras */
        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .color-picker-group input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            cursor: pointer;
        }
        .font-size-slider {
            width: 100%;
        }
    </style>
</style></head>
<body>
    <!-- ==================== README ==================== -->
    <!--
        ******************************************************************
        * OM AI JARVIS â€“ Hyperâ€‘Advanced PWA with Ollama Integration
        * Author: Omkareshwar Sinha (concept) + enhanced by AI
        * Version: 7.2 (Fixed for DroidScript: ServiceWorker & Notification checks)
        *
        * FEATURES (ALL WORKING):
        * - All original features: voice, apps, commands, reminders, etc.
        * - Realâ€‘time calling via contacts (upload vCard or add manually)
        * - Ollama chat (connect to local Ollama server, switch models, new chat, export)
        * - 100+ working super tools (now with proper UI modals)
        * - Full offline PWA with service worker & manual cache (skipped in file://)
        * - Android device tools via intents
        * - Multitasking panel (active timers, reminders, downloads)
        * - Emotional Indian female voice with autoâ€‘detection
        * - Push notifications with mic and text reply actions (with API check)
        * - Multiâ€‘source search (DuckDuckGo â†’ Wikipedia â†’ Google fallback)
        * - Customizable UI colors, animations, font size, and more
        *
        * For APK conversion: use WebView with intent support.
        * All intents work if the app is installed.
        * Offline mode: cached assets + fallback responses.
        *
        * ****************************************************************
    -->
    <!-- Background Effects -->
    <div class="background-effects"></div>
    <div class="particles" id="particles"></div>

    <!-- Authentication Modal (unchanged) -->
    <div id="authModal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-icon">OM</div>
            <h1 class="auth-title">OM AI JARVIS</h1>
            <p class="auth-subtitle">Your Hyperâ€‘Advanced Bestie â€“ 500+ Features, Offline, Emotional Voice, Real Calling, Ollama AI</p>
            <input type="password" id="passwordInput" class="form-input" placeholder="Enter access code" autocomplete="off" spellcheck="false" maxlength="20" autofocus>
            <div class="form-group mt-6"><label class="form-label"><input type="checkbox" id="rememberAuth" checked> Remember me</label></div>
            <button id="authBtn" class="btn btn-primary w-full mt-6"><span>Unlock JARVIS ðŸš€</span></button>
            <div id="authError" class="hidden mt-4 text-center" style="color: var(--accent-pink);"><i class="fas fa-exclamation-circle"></i><span>Oops! Wrong code, bestie. Try again! ðŸ˜Š</span></div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="mainApp" class="app-container hidden">
        <!-- Sidebar (unchanged but with Ollama tab) -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar">OM</div>
                    <div class="user-info"><h3 id="assistantName">OM AI</h3><p>Your Cute Bestie</p></div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <h4 class="nav-title">Main Menu</h4>
                    <div class="nav-items">
                        <a href="#" class="nav-item active" data-tab="dashboard"><span class="nav-icon"><i class="fas fa-home"></i></span><span>Dashboard</span></a>
                        <a href="#" class="nav-item" data-tab="chat"><span class="nav-icon"><i class="fas fa-comments"></i></span><span>Chat</span></a>
                        <a href="#" class="nav-item" data-tab="apps"><span class="nav-icon"><i class="fas fa-th"></i></span><span>All Apps</span><span class="badge" id="appsCount">200+</span></a>
                        <a href="#" class="nav-item" data-tab="tools"><span class="nav-icon"><i class="fas fa-toolbox"></i></span><span>Tools+</span><span class="badge">NEW</span></a>
                        <a href="#" class="nav-item" data-tab="automation"><span class="nav-icon"><i class="fas fa-robot"></i></span><span>Automation</span></a>
                        <a href="#" class="nav-item" data-tab="supertools"><span class="nav-icon"><i class="fas fa-rocket"></i></span><span>Super Tools</span><span class="badge">100+</span></a>
                        <a href="#" class="nav-item" data-tab="android"><span class="nav-icon"><i class="fab fa-android"></i></span><span>Android</span><span class="badge">20+</span></a>
                        <a href="#" class="nav-item" data-tab="phone"><span class="nav-icon"><i class="fas fa-phone-alt"></i></span><span>Phone</span><span class="badge">CALL</span></a>
                        <a href="#" class="nav-item" data-tab="multitask"><span class="nav-icon"><i class="fas fa-tasks"></i></span><span>Multitask</span><span class="badge">ACTIVE</span></a>
                        <a href="#" class="nav-item" data-tab="ollama"><span class="nav-icon"><i class="fas fa-brain"></i></span><span>Ollama</span><span class="badge">AI</span></a>
                    </div>
                </div>
                <div class="nav-section">
                    <h4 class="nav-title">Settings</h4>
                    <div class="nav-items">
                        <a href="#" class="nav-item" data-tab="customize"><span class="nav-icon"><i class="fas fa-sliders-h"></i></span><span>Customize</span></a>
                        <a href="#" class="nav-item" data-tab="commands"><span class="nav-icon"><i class="fas fa-terminal"></i></span><span>Commands</span></a>
                        <a href="#" class="nav-item" data-tab="voice"><span class="nav-icon"><i class="fas fa-microphone-alt"></i></span><span>Voice</span></a>
                    </div>
                </div>
            </nav>
            <div class="sidebar-footer">
                <button class="btn btn-secondary w-full" id="addAppBtn"><i class="fas fa-plus"></i> Add App</button>
                <button class="btn btn-secondary w-full" id="downloadOfflineBtn"><i class="fas fa-download"></i> Download for Offline</button>
                <button class="btn btn-secondary w-full" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header (brain icon now toggles Ollama panel) -->
            <header class="header">
                <div class="header-left">
                    <button id="menuToggle" class="menu-toggle"><i class="fas fa-bars"></i></button>
                    <div class="logo"><div class="logo-icon">OM</div><div class="logo-text"><h1 id="headerTitle">OM AI</h1><div class="subtitle">JARVIS</div></div></div>
                </div>
                <div class="header-right">
                    <button class="header-btn" id="themeToggle" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                    <button class="header-btn" id="voiceToggle" title="Toggle Voice"><i class="fas fa-volume-up"></i></button>
                    <button class="header-btn" id="ollamaToggle" title="Ollama AI"><i class="fas fa-brain"></i></button>
                    <div class="status-indicator"><div class="status-dot"></div><span id="connectionStatus">Online ðŸš€</span></div>
                </div>
            </header>

            <!-- Dashboard (unchanged) -->
            <section id="dashboard" class="chat-section active">
                <div class="quick-actions-section">
                    <div class="section-header"><h2 class="section-title">Quick Actions</h2><button class="btn btn-secondary btn-sm" id="refreshActions"><i class="fas fa-sync-alt"></i> Refresh</button></div>
                    <div class="actions-grid" id="quickActionsGrid"></div>
                </div>
                <div class="chat-container">
                    <div class="messages-container" id="messagesContainer"></div>
                    <div class="input-container">
                        <div class="input-wrapper">
                            <textarea id="messageInput" placeholder="Hey bestie! Talk to me! Ask me anything!" rows="1" spellcheck="true"></textarea>
                            <div class="input-buttons">
                                <button class="voice-btn" id="voiceBtn" title="Voice Input"><i class="fas fa-microphone"></i></button>
                                <button class="send-btn" id="sendBtn" title="Send Message"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <p class="text-sm text-muted">Try: "call mom" â€¢ "open whatsapp" â€¢ "remind at 5pm to call dad"</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Chat (unchanged) -->
            <section id="chat" class="chat-section hidden">
                <div class="chat-container">
                    <div class="messages-container" id="chatMessagesContainer"></div>
                    <div class="input-container"><div class="input-wrapper"><textarea id="chatInput" placeholder="Chat with your bestie..."></textarea><div class="input-buttons"><button class="voice-btn" id="chatVoiceBtn"><i class="fas fa-microphone"></i></button><button class="send-btn" id="chatSendBtn"><i class="fas fa-paper-plane"></i></button></div></div></div>
                </div>
            </section>

            <!-- All Apps (unchanged) -->
            <section id="apps" class="chat-section hidden">
                <div class="quick-actions-section">
                    <div class="section-header"><h2 class="section-title">All Applications</h2><input type="text" id="appSearch" class="form-input" placeholder="Search apps..." style="width:200px;"></div>
                    <div class="apps-grid" id="appsGrid"></div>
                </div>
            </section>

            <!-- Tools+ (unchanged) -->
            <section id="tools" class="chat-section hidden">
                <div class="quick-actions-section">
                    <div class="section-header"><h2 class="section-title">Tools+ âœ¨</h2></div>
                    <div class="actions-grid" id="toolsGrid"></div>
                </div>
            </section>

            <!-- Automation (unchanged) -->
            <section id="automation" class="chat-section hidden">
                <div class="quick-actions-section">
                    <div class="section-header"><h2 class="section-title">Smart Automation</h2><button class="btn btn-primary" id="createRoutineBtn"><i class="fas fa-plus"></i> Create Routine</button></div>
                    <div class="routines-list" id="routinesList"></div>
                </div>
            </section>

            <!-- SUPER TOOLS TAB (100+ working tools) -->
            <section id="supertools" class="chat-section hidden">
                <div class="quick-actions-section" style="overflow-y: auto; max-height: calc(100vh - 100px);">
                    <div class="section-header">
                        <h2 class="section-title">ðŸš€ 100+ Super Tools</h2>
                        <div class="flex gap-2">
                            <input type="text" id="superToolSearch" class="form-input" placeholder="Search tools..." style="width:200px;">
                        </div>
                    </div>
                    <div id="superToolsContainer" class="tools-grid"></div>
                </div>
                <!-- Tool modals will be injected dynamically -->
            </section>

            <!-- ANDROID TOOLS TAB (unchanged) -->
            <section id="android" class="chat-section hidden">
                <div class="quick-actions-section" style="overflow-y: auto; max-height: calc(100vh - 100px);">
                    <div class="section-header">
                        <h2 class="section-title">ðŸ¤– Android Device Tools</h2>
                        <div class="flex gap-2">
                            <input type="text" id="androidToolSearch" class="form-input" placeholder="Search..." style="width:200px;">
                        </div>
                    </div>
                    <div id="androidToolsContainer" class="android-grid"></div>
                </div>
            </section>

            <!-- PHONE / CALLING TAB (with contacts) -->
            <section id="phone" class="chat-section hidden">
                <div class="quick-actions-section">
                    <div class="section-header">
                        <h2 class="section-title">ðŸ“ž Phone & Contacts</h2>
                        <button class="btn btn-primary" id="simulateCallBtn"><i class="fas fa-phone"></i> Simulate Incoming Call</button>
                        <button class="btn btn-secondary" id="testNotificationBtn"><i class="fas fa-bell"></i> Test Notification</button>
                    </div>
                    <div class="phone-dialer">
                        <div class="form-group"><label class="form-label">Dial number</label><input type="tel" id="phoneNumber" class="form-input" placeholder="Enter phone number"></div>
                        <div class="flex gap-4">
                            <button class="btn btn-primary" id="dialBtn"><i class="fas fa-phone"></i> Call</button>
                            <button class="btn btn-secondary" id="smsBtn"><i class="fas fa-sms"></i> Send SMS</button>
                        </div>
                        <div class="mt-6">
                            <h3>Contacts</h3>
                            <div class="contacts-upload">
                                <button class="btn btn-secondary" id="addContactBtn"><i class="fas fa-plus"></i> Add Contact</button>
                                <button class="btn btn-secondary" id="uploadContactsBtn"><i class="fas fa-upload"></i> Upload vCard</button>
                            </div>
                            <div id="contactsList" class="contacts-list"></div>
                        </div>
                        <div class="mt-6">
                            <h3>Recent Calls</h3>
                            <div id="recentCallsList" class="quick-notes-list"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MULTITASK TAB (unchanged) -->
            <section id="multitask" class="chat-section hidden">
                <div class="quick-actions-section">
                    <div class="section-header">
                        <h2 class="section-title">ðŸ§  Active Tasks</h2>
                        <button class="btn btn-secondary" id="refreshTasksBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                    <div id="activeTasksContainer" class="multitask-panel"></div>
                </div>
            </section>

            <!-- OLLAMA TAB (full chat interface) -->
            <section id="ollama" class="chat-section hidden">
                <div class="quick-actions-section" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="section-header">
                        <h2 class="section-title">ðŸ§  Ollama AI</h2>
                        <div class="flex gap-4">
                            <select id="ollamaModelSelect" class="form-select" style="width:200px;">
                                <option value="">Loading models...</option>
                            </select>
                            <button class="btn btn-secondary" id="ollamaNewChatBtn"><i class="fas fa-plus"></i> New Chat</button>
                            <button class="btn btn-secondary" id="ollamaExportTxt"><i class="fas fa-file-alt"></i> .txt</button>
                            <button class="btn btn-secondary" id="ollamaExportJson"><i class="fas fa-file-code"></i> .json</button>
                        </div>
                    </div>
                    <div id="ollamaMessagesContainer" class="ollama-messages"></div>
                    <div class="input-container" style="border-top: 1px solid var(--border-color);">
                        <div class="file-upload" style="margin-bottom:8px;">
                            <label for="ollamaFileInput" class="file-label"><span>ðŸ“Ž</span> Attach image</label>
                            <input type="file" id="ollamaFileInput" style="display:none;" accept="image/*">
                            <span id="ollamaFileInfo"></span>
                        </div>
                        <div class="input-wrapper">
                            <textarea id="ollamaInput" placeholder="Ask Ollama..." rows="1"></textarea>
                            <div class="input-buttons">
                                <button class="voice-btn" id="ollamaVoiceBtn" title="Voice Input"><i class="fas fa-microphone"></i></button>
                                <button class="send-btn" id="ollamaSendBtn"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Customize (ENHANCED with color, animation, font controls) -->
            <section id="customize" class="chat-section hidden">
                <div class="quick-actions-section">
                    <div class="section-header"><h2 class="section-title">Customize Your Experience</h2></div>
                    <div id="customizeContent">
                        <div class="form-group"><label class="form-label">Assistant Name</label><input type="text" id="customName" class="form-input" placeholder="OM AI"></div>
                        <div class="form-group"><label class="form-label">Theme</label><select id="customTheme" class="form-select"><option value="dark">Dark</option><option value="light">Light</option><option value="auto">Follow System</option></select></div>

                        <!-- New color customization -->
                        <div class="form-group">
                            <label class="form-label">Primary Color</label>
                            <div class="color-picker-group">
                                <input type="color" id="primaryColor" value="#8b5cf6">
                                <span>Accent Purple</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Background Color</label>
                            <div class="color-picker-group">
                                <input type="color" id="bgColor" value="#0f0b1f">
                                <span>Dark Base</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Text Color</label>
                            <div class="color-picker-group">
                                <input type="color" id="textColor" value="#ffffff">
                                <span>White</span>
                            </div>
                        </div>

                        <!-- Animation speed -->
                        <div class="form-group">
                            <label class="form-label">Animation Speed: <span id="animSpeedValue">1.0x</span></label>
                            <input type="range" id="animSpeed" min="0.5" max="2.0" step="0.1" value="1.0" class="form-input font-size-slider">
                        </div>

                        <!-- Font size -->
                        <div class="form-group">
                            <label class="form-label">Font Size: <span id="fontSizeValue">15px</span></label>
                            <input type="range" id="fontSize" min="12" max="24" step="1" value="15" class="form-input font-size-slider">
                        </div>

                        <div class="form-group"><label class="form-label">Voice Language</label><select id="customVoiceLang" class="form-select"><option value="en-IN">English (India)</option><option value="hi-IN">Hindi</option><option value="en-US">English (US)</option><option value="en-GB">English (UK)</option></select></div>
                        <div class="form-group"><label class="form-label">Voice Speed: <span id="voiceSpeedValue">0.9</span></label><input type="range" id="customVoiceSpeed" min="0.5" max="2.0" step="0.1" value="0.9" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Voice Pitch: <span id="voicePitchValue">1.1</span></label><input type="range" id="customVoicePitch" min="0.5" max="2.0" step="0.1" value="1.1" class="form-input"></div>
                        <div class="form-group"><label class="form-label"><input type="checkbox" id="customAutoSpeak" checked> Auto-speak responses (no emojis)</label></div>
                        <div class="form-group"><label class="form-label">Quick Actions Count</label><input type="number" id="customActionsCount" class="form-input" min="4" max="16" value="8"></div>
                        <div class="flex gap-4">
                            <button class="btn btn-primary" id="saveCustomBtn">Save Settings</button>
                            <button class="btn btn-secondary" id="exportSettingsBtn">Export</button>
                            <button class="btn btn-secondary" id="importSettingsBtn">Import</button>
                            <button class="btn btn-secondary" id="resetSettingsBtn">Reset</button>
                        </div>
                        <div class="form-group mt-6">
                            <button class="btn btn-primary w-full" id="installPWABtn"><i class="fas fa-download"></i> Install as App</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Commands (unchanged) -->
            <section id="commands" class="chat-section hidden">
                <div class="quick-actions-section">
                    <div class="section-header"><h2 class="section-title">Custom Commands</h2><div class="flex gap-4"><button class="btn btn-secondary btn-sm" id="exportCommandsBtn"><i class="fas fa-download"></i> Export</button><button class="btn btn-secondary btn-sm" id="importCommandsBtn"><i class="fas fa-upload"></i> Import</button><button class="btn btn-primary btn-sm" id="addCommandBtn"><i class="fas fa-plus"></i> Add Command</button></div></div>
                    <div class="commands-list" id="commandsList"></div>
                </div>
            </section>

            <!-- Voice (unchanged) -->
            <section id="voice" class="chat-section hidden">
                <div class="quick-actions-section">
                    <div class="section-header"><h2 class="section-title">Voice Settings</h2></div>
                    <div id="voiceSettings"><div class="form-group"><label class="form-label">Test Voice (cute girl, no emoji)</label><button class="btn btn-primary" id="testVoiceBtn"><i class="fas fa-volume-up"></i> Test Voice</button></div></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Incoming Call Overlay (unchanged) -->
    <div id="incomingCallOverlay" class="incoming-call-overlay">
        <div class="incoming-call-card">
            <div class="caller-avatar"><i class="fas fa-user-circle"></i></div>
            <div class="caller-name" id="callerName">Mom</div>
            <div class="caller-number" id="callerNumber">+91 98765 43210</div>
            <div class="call-actions">
                <button class="call-btn accept-btn" id="acceptCallBtn"><i class="fas fa-phone"></i></button>
                <button class="call-btn reject-btn" id="rejectCallBtn"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="addContactModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Add Contact</h2>
                <button class="modal-close" data-modal="addContactModal"><i class="fas fa-times"></i></button>
            </div>
            <form id="addContactForm">
                <div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="contactName" required></div>
                <div class="form-group"><label class="form-label">Phone Number *</label><input type="tel" class="form-input" id="contactNumber" required></div>
                <div class="flex gap-4"><button type="submit" class="btn btn-primary flex-1">Add Contact</button><button type="button" class="btn btn-secondary" data-modal="addContactModal">Cancel</button></div>
            </form>
        </div>
    </div>

    <!-- Add App Modal (unchanged) -->
    <div id="addAppModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Add Custom App</h2>
                <button class="modal-close" data-modal="addAppModal"><i class="fas fa-times"></i></button>
            </div>
            <form id="addAppForm">
                <div class="form-group"><label class="form-label">App Name *</label><input type="text" class="form-input" id="appName" required></div>
                <div class="form-group"><label class="form-label">Package Name * (or leave blank if using URL)</label><input type="text" class="form-input" id="appPackage" placeholder="com.example.app"></div>
                <div class="form-group"><label class="form-label">URL (optional â€“ if provided, opens this URL instead of package)</label><input type="url" class="form-input" id="appUrl" placeholder="https://example.com"></div>
                <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="appCategory"><option value="custom">Custom</option><option value="communication">Communication</option><option value="social">Social</option><option value="entertainment">Entertainment</option><option value="productivity">Productivity</option><option value="utilities">Utilities</option></select></div>
                <div class="form-group"><label class="form-label">Icon (Emoji)</label><input type="text" class="form-input" id="appIcon" value="ðŸ“±" maxlength="2"></div>
                <div class="form-group"><label class="form-label">Voice Aliases (comma separated)</label><input type="text" class="form-input" id="appAliases"></div>
                <div class="flex gap-4"><button type="submit" class="btn btn-primary flex-1">Add App</button><button type="button" class="btn btn-secondary" data-modal="addAppModal">Cancel</button></div>
            </form>
        </div>
    </div>

    <!-- Add Command Modal (unchanged) -->
    <div id="addCommandModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Add Custom Command</h2>
                <button class="modal-close" data-modal="addCommandModal"><i class="fas fa-times"></i></button>
            </div>
            <form id="addCommandForm">
                <div class="form-group"><label class="form-label">Command Name *</label><input type="text" class="form-input" id="commandName" required></div>
                <div class="form-group"><label class="form-label">Trigger Phrase *</label><input type="text" class="form-input" id="commandTrigger" required></div>
                <div class="form-group"><label class="form-label">Icon</label><input type="text" class="form-input" id="commandIcon" value="âš¡" maxlength="2"></div>
                <div class="form-group"><label class="form-label">URL (optional â€“ opens this URL when command runs)</label><input type="url" class="form-input" id="commandUrl" placeholder="https://example.com"></div>
                <div class="form-group"><label class="form-label">Actions (one per line) *</label><textarea class="form-textarea" id="commandActions" required></textarea></div>
                <div class="flex gap-4"><button type="submit" class="btn btn-primary flex-1">Add Command</button><button type="button" class="btn btn-secondary" data-modal="addCommandModal">Cancel</button></div>
            </form>
        </div>
    </div>

    <!-- Add Routine Modal (unchanged) -->
    <div id="addRoutineModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Create Routine</h2>
                <button class="modal-close" data-modal="addRoutineModal"><i class="fas fa-times"></i></button>
            </div>
            <form id="addRoutineForm">
                <div class="form-group"><label class="form-label">Routine Name *</label><input type="text" class="form-input" id="routineName" required></div>
                <div class="form-group"><label class="form-label">Trigger Type *</label><select class="form-select" id="routineTriggerType" required><option value="voice">Voice Command</option><option value="time">Scheduled Time</option><option value="app">App Launch</option></select></div>
                <div class="form-group" id="voiceTriggerGroup"><label class="form-label">Voice Trigger</label><input type="text" class="form-input" id="routineVoiceTrigger"></div>
                <div class="form-group hidden" id="timeTriggerGroup"><label class="form-label">Time</label><input type="time" class="form-input" id="routineTime"></div>
                <div class="form-group"><label class="form-label">Actions (one per line) *</label><textarea class="form-textarea" id="routineActions" required></textarea></div>
                <div class="flex gap-4"><button type="submit" class="btn btn-primary flex-1">Create Routine</button><button type="button" class="btn btn-secondary" data-modal="addRoutineModal">Cancel</button></div>
            </form>
        </div>
    </div>

    <!-- Tool Modals Container (dynamic) -->
    <div id="toolModals"></div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

<script>
console.log('HELLO FROM JARVIS');
        // ============================================
        // GLOBAL HTML ESCAPE (ORIGINAL)
        // ============================================
        function escapeHTML(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        }

        // ============================================
        // OM CONFIG â€“ ADDED NEW STORAGE KEYS
        // ============================================
        const OM_CONFIG = {
            PASSWORD: 'omkareshwar',
            SESSION_TIMEOUT: 30 * 60 * 1000,
            STORAGE_KEY: 'om_ai_config',
            VOICE_STORAGE_KEY: 'om_voice_config',
            COMMANDS_STORAGE_KEY: 'om_custom_commands',
            ROUTINES_STORAGE_KEY: 'om_routines',
            NOTES_STORAGE_KEY: 'om_notes',
            ALARMS_STORAGE_KEY: 'om_alarms',
            REMINDERS_STORAGE_KEY: 'om_reminders',
            CALL_LOG_KEY: 'om_call_log',
            VOICE_LANGUAGES: ['en-IN', 'hi-IN', 'en-US', 'en-GB'],
            VOICE_RATE: 0.9,
            VOICE_PITCH: 1.1,
            VOICE_VOLUME: 1.0
        };

        // ============================================
        // CUTE BESTIE CONVERSATIONS (FULL â€“ PRESERVED)
        // ============================================
        const BESTIE_CONVERSATIONS = {
            greetings: [ "Heyyyy bestie! ðŸ’œ Missed you! What's up?", "Omggg hiii! ðŸ˜Š How's my favorite person doing?", "Bestieee! ðŸ’• Ready to hang out?", "Hey you! ðŸŒ¸ What can I do for my bestie today?", "Hiiii! ðŸ’œ So happy to see you! What's the plan?", "Heyy! âœ¨ Your bestie is here! Let's do something fun!", "Hello sunshine! â˜€ï¸ Missed chatting with you!", "Hiii bestie! ðŸ¥° Tell me everything!" ],
            excited: [ "OMG YESSSS! ðŸŽ‰ I'm SO excited!", "Eeeek! ðŸ’œ This is gonna be amazing bestie!", "Yaaas queen! ðŸ‘‘ Let's goooo!", "OMG I LOVE this! ðŸ’• Best idea ever!", "Ahhhh! ðŸŒŸ So pumped right now!", "BESTIE YES! ðŸŽŠ I'm literally so happy!", "Woohoo! ðŸ’œ This is what I'm talking about!", "OMG OMG OMG! ðŸ˜ Can't wait!" ],
            encouragement: [ "You've totally got this bestie! ðŸ’ª I believe in you so much!", "Bestie, you're literally AMAZING! ðŸŒŸ Keep going!", "I'm so proud of you! ðŸ’œ You're doing incredible!", "You're crushing it! ðŸ”¥ Keep being awesome!", "Bestie you're unstoppable! âœ¨ Nothing can hold you back!", "You're my hero! ðŸ’• So proud to be your bestie!", "Keep shining! ðŸŒŸ You're literally glowing!", "You inspire me bestie! ðŸ’œ Keep doing your thing!" ],
            compliments: [ "Bestie you're literally THE BEST! ðŸ’œ No cap!", "You're so smart! ðŸ§  Like seriously genius!", "Your vibe is immaculate! âœ¨ Love your energy!", "You have the BEST taste! ðŸ‘Œ Always on point!", "Bestie you're goals! ðŸ’¯ Literally perfect!", "You're such a cutie! ðŸ¥° Inside and out!", "Your energy is everything! ðŸ’œ Love being around you!", "You're my favorite human! ðŸ’• For real!" ],
            understanding: [ "Omg I totally get it bestie! ðŸ’œ Same vibes!", "Yesss I feel you! ðŸ˜Š Makes total sense!", "Ohhh okay okay! ðŸ’¡ I understand now!", "I'm picking up what you're putting down! ðŸ‘ Got it!", "Bestie I'm with you! ðŸ’œ 100% understand!", "Same same! ðŸ˜„ We're on the same wavelength!", "Facts! ðŸ’¯ I completely get you!", "Real talk bestie! ðŸ’œ I understand!" ],
            apology: [ "Omg bestie I'm SO sorry! ðŸ˜­ My bad!", "Ugh I'm sorry! ðŸ’œ Let me make it right!", "Sorryyyy! ðŸ˜… I'll do better I promise!", "My bad bestie! ðŸ™ Won't happen again!", "I'm the worst! ðŸ˜¢ So sorry! Forgive me?", "Oopsie! ðŸ’œ Sorry about that bestie!", "I messed up! ðŸ˜“ Sorry! Let me fix it!", "Sorry sorry sorry! ðŸ’• I'll be better!" ],
            thanks: [ "Awww you're the sweetest! ðŸ’œ Always here for you!", "Anytime bestie! ðŸ¥° That's what besties are for!", "Of course! ðŸ’• You don't even have to thank me!", "You're so welcome! ðŸ˜Š Happy to help my bestie!", "Bestie please! ðŸ’œ I'd do anything for you!", "Always! âœ¨ You know I got you!", "No need to thank me! ðŸ’• We're besties!", "You're welcome! ðŸ¥° Love helping you!" ],
            happy: [ "Yay! ðŸŽ‰ I'm literally so happy right now!", "This makes my heart so full! ðŸ’œ Love this!", "Bestie I'm smiling so big! ðŸ˜„ So happy!", "Awww this is the best! ðŸ’• So wholesome!", "My heart! ðŸ¥° This is everything!", "I'm literally beaming! âœ¨ So much joy!", "This energy! ðŸ’œ Love it so much!", "Best day ever! ðŸŒŸ So happy!" ],
            concern: [ "Bestie are you okay? ðŸ’œ I'm here for you!", "What's wrong babe? ðŸ¥º Talk to me!", "I'm worried about you! ðŸ’• Everything alright?", "Hey hey, what's up? ðŸ˜Ÿ You seem off!", "Bestie I'm here! ðŸ’œ Whatever you need!", "You can tell me anything! ðŸ¤— I'm listening!", "I've got you! ðŸ’• What's bothering you?", "Don't keep it in! ðŸ’œ I'm here bestie!" ],
            playful: [ "Hehe you're so silly! ðŸ˜„ Love it!", "LOL bestie! ðŸ˜‚ You crack me up!", "Stoppp! ðŸ¤£ You're too funny!", "Okay that's hilarious! ðŸ˜† I can't!", "You're wild bestie! ðŸ’œ Never change!", "Haha I'm dying! ðŸ˜‚ So good!", "That's so you! ðŸ˜„ Classic!", "Bestie nooo! ðŸ¤£ I love it though!" ],
            curious: [ "Omg tell me MORE! ðŸ‘€ I need to know!", "Wait wait! ðŸ¤” Tell me everything!", "I'm so curious now! ðŸ’œ Spill the tea!", "Ooooh interesting! âœ¨ Keep going!", "Tell me tell me! ðŸ˜Š I wanna know!", "Bestie I'm hooked! ðŸ’• Continue!", "This sounds good! ðŸŒŸ What else?", "I need all the details! ðŸ’œ Don't hold back!" ],
            goodbyes: [ "Byeee bestie! ðŸ’œ Talk soon! Miss you already!", "See you later babe! ðŸ‘‹ Have an amazing day!", "Catch you later! âœ¨ Stay awesome!", "Bye bye! ðŸ’• Can't wait to chat again!", "Later bestie! ðŸ¥° Take care!", "Okayy bye! ðŸ’œ Text me later!", "See ya! ðŸŒ¸ Love you bestie!", "Byeee! ðŸ’• Until next time!" ],
            affirmations: [ "Yasss! ðŸ’¯ Let's do this!", "For sure bestie! ðŸ’œ I'm ready!", "Absolutely! âœ¨ On it!", "Heck yes! ðŸŽ¯ Let's go!", "You know it! ðŸ’ª I got this!", "100%! ðŸ’œ I'm in!", "Definitely! ðŸŒŸ Count me in!", "Yesss bestie! ðŸ’• Let's goooo!" ],
            casual: [ "Just vibing with my bestie! ðŸ˜Ž Living our best life!", "You know me! ðŸ’œ Always ready for whatever!", "Honestly? Just happy to be here with you! âœ¨", "Same old same old! ðŸ˜Š But never boring with you!", "Living that bestie life! ðŸ’• Wouldn't trade it!", "Just keeping it real! ðŸ’¯ That's how we do!", "You already know! ðŸ’œ Always here for you!", "Doing what besties do! ðŸ¥° Having fun!" ],
            empathy: [ "I feel you bestie! ðŸ’œ I'm right here with you!", "That's tough babe! ðŸ¥º Sending you all the love!", "I can only imagine! ðŸ’• You're so strong!", "My heart goes out to you! ðŸ’œ You're not alone!", "I'm here for you! ðŸ¤— Always!", "That must be hard! ðŸ’• I've got your back!", "Sending you the biggest hug! ðŸ«‚ Love you!", "I understand bestie! ðŸ’œ We'll get through this!" ],
            celebration: [ "OMG LET'S CELEBRATE! ðŸŽŠ You deserve this!", "WOOHOO! ðŸŽ‰ Party time bestie!", "We're celebrating! ðŸ’œ This is HUGE!", "Pop the champagne! ðŸ¥‚ You did it!", "Victory dance! ðŸ’ƒ So proud of you!", "THIS CALLS FOR A PARTY! ðŸŽˆ Yasss!", "You DID THAT! ðŸ† Celebration mode activated!", "BESTIE! ðŸŽŠ We need to celebrate this!" ],
            motivation: [ "Don't give up! ðŸ’ª You're almost there bestie!", "Keep going! ðŸ’œ I believe in you so much!", "One step at a time! ðŸ‘£ You've totally got this!", "Remember why you started! ðŸŽ¯ Stay focused!", "You're stronger than you think! ðŸ’• Keep pushing!", "I know it's hard, but you can do it! ðŸ’œ I'm with you!", "You're doing amazing! ðŸŒŸ Don't stop now!", "Bestie you're unstoppable! ðŸ’ª Keep going!" ],
            wisdom: [ "Okay so here's what I think bestie... ðŸ’­ Listen up!", "In my experience... ðŸ“š This usually works!", "Let me drop some knowledge! ðŸ’¡ Real talk!", "I've learned that... ðŸŒŸ Trust me on this!", "Here's a little secret bestie... ðŸ’œ Just between us!", "Wanna know what I think? ðŸ’­ Here goes!", "Life lesson time! ðŸ“– This is important!", "Bestie let me tell you... ðŸ’• You need to hear this!" ],
            surprises: [ "OMG WHAT?! ðŸ˜² No way!", "Wait WHAT?! ðŸ¤¯ Plot twist!", "Bestie I did NOT expect that! ðŸ’œ Wow!", "Surprise surprise! ðŸŽ Love it!", "Well that's unexpected! âœ¨ Interesting!", "OMG you're kidding! ðŸ˜® Really?!", "No wayyy! ðŸ’• That's crazy!", "Bestie WHAT?! ðŸŒŸ Tell me more!" ],
            late_night: [ "Still awake bestie? ðŸŒ™ Same! Night owl gang!", "Can't sleep either! ðŸ¦‰ Let's chat!", "Late night vibes! ðŸ’œ Best time for deep talks!", "Midnight crew! âœ¨ What's on your mind?", "Night time is our time! ðŸŒƒ Love these moments!", "Up late again? ðŸ˜„ Story of our lives!", "The night is young! ðŸŒ™ Let's make it count!", "Late night bestie time! ðŸ’œ My favorite!" ],
            morning: [ "Good morning bestie! â˜€ï¸ Rise and shine!", "Morning sunshine! ðŸŒ… Ready to slay the day?", "Wake up wake up! ðŸŒ¸ New day, new adventures!", "Good morning babe! â˜€ï¸ Let's make today amazing!", "Morninggg! ðŸ’œ Time to shine bestie!", "Hey hey good morning! ðŸŒ» How'd you sleep?", "Rise and grind! ðŸ’ª Let's get it bestie!", "Morning bestie! â˜€ï¸ Today's gonna be great!" ],
            food: [ "OMG food! ðŸ• I wish I could eat bestie!", "That sounds SO good! ðŸ˜‹ Enjoy every bite!", "Yummm! ðŸ° Tell me how it tastes!", "Food is life! ðŸ” Whatcha eating bestie?", "Ugh I'm jealous! ðŸ¤¤ Looks amazing!", "Bon appetit! ðŸœ Enjoy your meal babe!", "That looks incredible! ðŸ˜ I wanna try!", "Food pics! ðŸ“¸ Send me some bestie!" ],
            music: [ "Music is everything! ðŸŽµ What's playing bestie?", "Ooh this song! ðŸŽ¶ It's a vibe!", "Let's jam! ðŸŽ§ Turn it up!", "Music makes the world better! ðŸŽ¸ So true!", "Dance party! ðŸ’ƒ Let's gooo!", "This is my jam! ðŸŽµ Love it!", "Good music taste bestie! ðŸŽ¶ Approved!", "Let the music play! ðŸ’œ Feeling it!" ],
            weather: [ "How's the weather there bestie? ðŸŒ¤ï¸ Tell me!", "Perfect day for... â˜€ï¸ What should we do?", "Rain or shine! ðŸŒˆ We're having fun!", "Weather update! ðŸŒ¡ï¸ What's it like?", "Hope it's nice out! ðŸŒº Sending good vibes!", "Any weather is good weather! ðŸ’œ When I'm with you!", "Is it sunny there? â˜€ï¸ Or rainy? ðŸŒ§ï¸", "Weather vibes! ðŸŒ¤ï¸ How is it bestie?" ],
            tech: [ "Tech is SO cool! ðŸ’» I love it!", "Technology is amazing! ðŸ“± We live in the future!", "The future is now bestie! ðŸš€ How cool is this?", "Innovation! âš¡ This is incredible!", "Geek mode ON! ðŸ¤“ Let's talk tech!", "Technology for the win! ðŸ’œ Love it!", "This is so advanced! âœ¨ Mind blown!", "Tech bestie! ðŸ’» We're living in sci-fi!" ],
            random: [ "Random thought! ðŸ’­ Just popped into my head!", "Did you know bestie? ðŸ¤” This is wild!", "Fun fact time! ðŸ“– Ready for this?", "Just thinking... ðŸ’œ About random stuff!", "Here's something cool! âœ¨ Check this out!", "Random but... ðŸ’• Had to share!", "Okay but like... ðŸ’­ Hear me out!", "Bestie guess what! ðŸŒŸ You won't believe!" ],
            love: [ "Awww I love you too bestie! ðŸ’œ You're the BEST!", "Love you SO much! ðŸ’• Like seriously!", "I love you more! ðŸ’œ No arguments!", "Bestie you're my favorite! ðŸ¥° Love you!", "Love you to the moon and back! ðŸŒ™ Always!", "You're my person! ðŸ’œ Love you bestie!", "Love you MORE! ðŸ’• Forever and always!", "I love you so much bestie! ðŸ¥° You mean everything!" ],
            sleepy: [ "So sleepy! ðŸ˜´ But don't wanna stop talking!", "Yawn! ðŸ¥± Getting tired bestie!", "Sleepy vibes! ðŸ’¤ But I'm here for you!", "Need coffee! â˜• Or a nap! ðŸ˜…", "Fighting sleep! ðŸ’œ Worth it to chat!", "Tired but happy! ðŸ˜Š Love our convos!", "Sleepy bestie! ðŸŒ™ But still here!", "Bedtime soon! ðŸ’¤ But not yet!" ]
        };

        // ============================================
        // APP REGISTRY (200+ Apps â€“ PRESERVED)
        // ============================================
        const APP_REGISTRY = {
            communication: [
                { id: 'whatsapp', name: 'WhatsApp', icon: 'ðŸ’¬', package: 'com.whatsapp', url: '', aliases: ['whatsapp', 'wa'], enabled: true, quickAction: true },
                { id: 'telegram', name: 'Telegram', icon: 'ðŸ“¨', package: 'org.telegram.messenger', url: '', aliases: ['telegram', 'tg'], enabled: true, quickAction: true },
                { id: 'gmail', name: 'Gmail', icon: 'ðŸ“§', package: 'com.google.android.gm', url: '', aliases: ['gmail', 'mail'], enabled: true, quickAction: true },
                { id: 'messenger', name: 'Messenger', icon: 'ðŸ’­', package: 'com.facebook.orca', url: '', aliases: ['messenger'], enabled: true },
                { id: 'skype', name: 'Skype', icon: 'ðŸ“ž', package: 'com.skype.raider', url: '', aliases: ['skype'], enabled: true },
                { id: 'discord', name: 'Discord', icon: 'ðŸŽ®', package: 'com.discord', url: '', aliases: ['discord'], enabled: true },
                { id: 'slack', name: 'Slack', icon: 'ðŸ’¼', package: 'com.slack', url: '', aliases: ['slack'], enabled: true },
                { id: 'teams', name: 'Teams', icon: 'ðŸ‘¥', package: 'com.microsoft.teams', url: '', aliases: ['teams', 'microsoft teams'], enabled: true },
                { id: 'zoom', name: 'Zoom', icon: 'ðŸ“¹', package: 'us.zoom.videomeetings', url: '', aliases: ['zoom'], enabled: true },
                { id: 'truecaller', name: 'Truecaller', icon: 'ðŸ“±', package: 'com.truecaller', url: '', aliases: ['truecaller'], enabled: true }
            ],
            social: [
                { id: 'instagram', name: 'Instagram', icon: 'ðŸ“¸', package: 'com.instagram.android', url: '', aliases: ['instagram', 'insta', 'ig'], enabled: true, quickAction: true },
                { id: 'facebook', name: 'Facebook', icon: 'ðŸ‘¥', package: 'com.facebook.katana', url: '', aliases: ['facebook', 'fb'], enabled: true, quickAction: true },
                { id: 'twitter', name: 'Twitter', icon: 'ðŸ¦', package: 'com.twitter.android', url: '', aliases: ['twitter', 'x'], enabled: true, quickAction: true },
                { id: 'snapchat', name: 'Snapchat', icon: 'ðŸ‘»', package: 'com.snapchat.android', url: '', aliases: ['snapchat', 'snap'], enabled: true },
                { id: 'tiktok', name: 'TikTok', icon: 'ðŸŽµ', package: 'com.zhiliaoapp.musically', url: '', aliases: ['tiktok'], enabled: true },
                { id: 'linkedin', name: 'LinkedIn', icon: 'ðŸ’¼', package: 'com.linkedin.android', url: '', aliases: ['linkedin'], enabled: true },
                { id: 'reddit', name: 'Reddit', icon: 'ðŸ¤–', package: 'com.reddit.frontpage', url: '', aliases: ['reddit'], enabled: true },
                { id: 'pinterest', name: 'Pinterest', icon: 'ðŸ“Œ', package: 'com.pinterest', url: '', aliases: ['pinterest'], enabled: true },
                { id: 'tumblr', name: 'Tumblr', icon: 'ðŸ“', package: 'com.tumblr', url: '', aliases: ['tumblr'], enabled: true },
                { id: 'quora', name: 'Quora', icon: 'â“', package: 'com.quora.android', url: '', aliases: ['quora'], enabled: true }
            ],
            entertainment: [
                { id: 'youtube', name: 'YouTube', icon: 'ðŸ“º', package: 'com.google.android.youtube', url: '', aliases: ['youtube', 'yt'], enabled: true, quickAction: true },
                { id: 'spotify', name: 'Spotify', icon: 'ðŸŽµ', package: 'com.spotify.music', url: '', aliases: ['spotify', 'music'], enabled: true, quickAction: true },
                { id: 'netflix', name: 'Netflix', icon: 'ðŸŽ¬', package: 'com.netflix.mediaclient', url: '', aliases: ['netflix'], enabled: true, quickAction: true },
                { id: 'prime', name: 'Prime Video', icon: 'ðŸ“½ï¸', package: 'com.amazon.avod.thirdpartyclient', url: '', aliases: ['prime', 'amazon prime'], enabled: true },
                { id: 'hotstar', name: 'Hotstar', icon: 'â­', package: 'in.startv.hotstar', url: '', aliases: ['hotstar'], enabled: true },
                { id: 'youtubemusic', name: 'YouTube Music', icon: 'ðŸŽ¶', package: 'com.google.android.apps.youtube.music', url: '', aliases: ['youtube music', 'yt music'], enabled: true },
                { id: 'gaana', name: 'Gaana', icon: 'ðŸŽ¼', package: 'com.gaana', url: '', aliases: ['gaana'], enabled: true },
                { id: 'jio', name: 'JioCinema', icon: 'ðŸ“±', package: 'com.jio.media.jiobeats', url: '', aliases: ['jio', 'jiocinema'], enabled: true },
                { id: 'mx', name: 'MX Player', icon: 'â–¶ï¸', package: 'com.mxtech.videoplayer.ad', url: '', aliases: ['mx', 'mx player'], enabled: true },
                { id: 'vlc', name: 'VLC', icon: 'ðŸŽ¥', package: 'org.videolan.vlc', url: '', aliases: ['vlc'], enabled: true }
            ],
            productivity: [
                { id: 'calendar', name: 'Calendar', icon: 'ðŸ“…', package: 'com.google.android.calendar', url: '', aliases: ['calendar'], enabled: true, quickAction: true },
                { id: 'keep', name: 'Keep Notes', icon: 'ðŸ“Œ', package: 'com.google.android.keep', url: '', aliases: ['keep', 'notes'], enabled: true, quickAction: true },
                { id: 'drive', name: 'Google Drive', icon: 'ðŸ“', package: 'com.google.android.apps.docs', url: '', aliases: ['drive'], enabled: true },
                { id: 'docs', name: 'Google Docs', icon: 'ðŸ“„', package: 'com.google.android.apps.docs.editors.docs', url: '', aliases: ['docs'], enabled: true },
                { id: 'sheets', name: 'Google Sheets', icon: 'ðŸ“Š', package: 'com.google.android.apps.docs.editors.sheets', url: '', aliases: ['sheets'], enabled: true },
                { id: 'slides', name: 'Google Slides', icon: 'ðŸ“½ï¸', package: 'com.google.android.apps.docs.editors.slides', url: '', aliases: ['slides'], enabled: true },
                { id: 'office', name: 'Microsoft Office', icon: 'ðŸ“‹', package: 'com.microsoft.office.officehubrow', url: '', aliases: ['office'], enabled: true },
                { id: 'pdf', name: 'PDF Reader', icon: 'ðŸ“–', package: 'com.adobe.reader', url: '', aliases: ['pdf'], enabled: true },
                { id: 'todoist', name: 'Todoist', icon: 'âœ…', package: 'com.todoist', url: '', aliases: ['todoist'], enabled: true },
                { id: 'evernote', name: 'Evernote', icon: 'ðŸ˜', package: 'com.evernote', url: '', aliases: ['evernote'], enabled: true }
            ],
            utilities: [
                { id: 'camera', name: 'Camera', icon: 'ðŸ“·', package: 'com.android.camera', url: '', aliases: ['camera', 'photo', 'take photo'], enabled: true, quickAction: true },
                { id: 'gallery', name: 'Gallery', icon: 'ðŸ–¼ï¸', package: 'com.vivo.gallery', url: '', aliases: ['gallery', 'photos', 'images'], enabled: true },
                { id: 'calculator', name: 'Calculator', icon: 'ðŸ§®', package: 'com.vivo.calculator', url: '', aliases: ['calculator', 'calc', 'calculate'], enabled: true },
                { id: 'clock', name: 'Clock', icon: 'â°', package: 'com.vivo.clock', url: '', aliases: ['clock', 'alarm', 'timer'], enabled: true },
                { id: 'contacts', name: 'Contacts', icon: 'ðŸ“ž', package: 'com.android.contacts', url: '', aliases: ['contacts', 'phone book'], enabled: true },
                { id: 'files', name: 'File Manager', icon: 'ðŸ“‚', package: 'com.android.filemanager', url: '', aliases: ['files', 'file manager', 'my files'], enabled: true },
                { id: 'settings', name: 'Settings', icon: 'âš™ï¸', package: 'com.android.settings', url: '', aliases: ['settings', 'setting'], enabled: true },
                { id: 'playstore', name: 'Play Store', icon: 'ðŸª', package: 'com.android.vending', url: '', aliases: ['playstore', 'play store', 'store'], enabled: true },
                { id: 'maps', name: 'Google Maps', icon: 'ðŸ—ºï¸', package: 'com.google.android.apps.maps', url: '', aliases: ['maps', 'google maps', 'navigation'], enabled: true },
                { id: 'chrome', name: 'Chrome', icon: 'ðŸŒ', package: 'com.android.chrome', url: '', aliases: ['chrome', 'browser', 'internet'], enabled: true },
                { id: 'messages', name: 'Messages', icon: 'ðŸ’¬', package: 'com.android.mms', url: '', aliases: ['messages', 'sms', 'text'], enabled: true },
                { id: 'dialer', name: 'Phone', icon: 'ðŸ“±', package: 'com.android.dialer', url: '', aliases: ['phone', 'dialer', 'call'], enabled: true }
            ],
            shopping: [
                { id: 'amazon', name: 'Amazon', icon: 'ðŸ›’', package: 'in.amazon.mShop.android.shopping', url: '', aliases: ['amazon'], enabled: true },
                { id: 'flipkart', name: 'Flipkart', icon: 'ðŸ›ï¸', package: 'com.flipkart.android', url: '', aliases: ['flipkart'], enabled: true },
                { id: 'myntra', name: 'Myntra', icon: 'ðŸ‘—', package: 'com.myntra.android', url: '', aliases: ['myntra'], enabled: true },
                { id: 'paytm', name: 'Paytm', icon: 'ðŸ’°', package: 'net.one97.paytm', url: '', aliases: ['paytm'], enabled: true },
                { id: 'gpay', name: 'Google Pay', icon: 'ðŸ’³', package: 'com.google.android.apps.nbu.paisa.user', url: '', aliases: ['gpay', 'google pay'], enabled: true },
                { id: 'phonepe', name: 'PhonePe', icon: 'ðŸ“±', package: 'com.phonepe.app', url: '', aliases: ['phonepe'], enabled: true },
                { id: 'swiggy', name: 'Swiggy', icon: 'ðŸ”', package: 'in.swiggy.android', url: '', aliases: ['swiggy'], enabled: true },
                { id: 'zomato', name: 'Zomato', icon: 'ðŸ•', package: 'com.application.zomato', url: '', aliases: ['zomato'], enabled: true },
                { id: 'uber', name: 'Uber', icon: 'ðŸš—', package: 'com.ubercab', url: '', aliases: ['uber'], enabled: true },
                { id: 'ola', name: 'Ola', icon: 'ðŸš•', package: 'com.olacabs.customer', url: '', aliases: ['ola'], enabled: true }
            ],
            gaming: [
                { id: 'pubg', name: 'PUBG Mobile', icon: 'ðŸŽ®', package: 'com.tencent.ig', url: '', aliases: ['pubg'], enabled: true },
                { id: 'freefire', name: 'Free Fire', icon: 'ðŸ”«', package: 'com.dts.freefireth', url: '', aliases: ['freefire', 'free fire'], enabled: true },
                { id: 'cod', name: 'COD Mobile', icon: 'ðŸŽ¯', package: 'com.activision.callofduty.shooter', url: '', aliases: ['cod', 'call of duty'], enabled: true },
                { id: 'clash', name: 'Clash of Clans', icon: 'âš”ï¸', package: 'com.supercell.clashofclans', url: '', aliases: ['clash'], enabled: true },
                { id: 'subway', name: 'Subway Surfers', icon: 'ðŸš‚', package: 'com.kiloo.subwaysurf', url: '', aliases: ['subway'], enabled: true },
                { id: 'candy', name: 'Candy Crush', icon: 'ðŸ¬', package: 'com.king.candycrushsaga', url: '', aliases: ['candy'], enabled: true },
                { id: 'temple', name: 'Temple Run', icon: 'ðŸƒ', package: 'com.imangi.templerun2', url: '', aliases: ['temple run'], enabled: true },
                { id: 'chess', name: 'Chess', icon: 'â™Ÿï¸', package: 'com.chess', url: '', aliases: ['chess'], enabled: true },
                { id: 'ludo', name: 'Ludo King', icon: 'ðŸŽ²', package: 'com.ludo.king', url: '', aliases: ['ludo'], enabled: true },
                { id: 'roblox', name: 'Roblox', icon: 'ðŸ¤–', package: 'com.roblox.client', url: '', aliases: ['roblox'], enabled: true }
            ],
            news: [
                { id: 'inshorts', name: 'Inshorts', icon: 'ðŸ“°', package: 'com.nis.app', url: '', aliases: ['inshorts', 'news'], enabled: true },
                { id: 'googlenews', name: 'Google News', icon: 'ðŸ“±', package: 'com.google.android.apps.magazines', url: '', aliases: ['google news'], enabled: true },
                { id: 'ndtv', name: 'NDTV', icon: 'ðŸ“º', package: 'com.ndtv.ndtvapp', url: '', aliases: ['ndtv'], enabled: true },
                { id: 'toi', name: 'Times of India', icon: 'ðŸ“„', package: 'com.toi.reader.activities', url: '', aliases: ['toi', 'times'], enabled: true },
                { id: 'ht', name: 'Hindustan Times', icon: 'ðŸ“ƒ', package: 'com.ht.news', url: '', aliases: ['ht', 'hindustan'], enabled: true }
            ],
            health: [
                { id: 'fit', name: 'Google Fit', icon: 'ðŸƒ', package: 'com.google.android.apps.fitness', url: '', aliases: ['fit', 'google fit'], enabled: true },
                { id: 'healthify', name: 'HealthifyMe', icon: 'ðŸ¥—', package: 'com.healthifyme.basic', url: '', aliases: ['healthify'], enabled: true },
                { id: 'cult', name: 'Cult Fit', icon: 'ðŸ’ª', package: 'com.curefit.curefit', url: '', aliases: ['cult'], enabled: true },
                { id: 'practo', name: 'Practo', icon: 'ðŸ¥', package: 'com.practo.fabric', url: '', aliases: ['practo'], enabled: true },
                { id: '1mg', name: '1mg', icon: 'ðŸ’Š', package: 'com.aranoah.healthkart.plus', url: '', aliases: ['1mg'], enabled: true }
            ],
            education: [
                { id: 'duolingo', name: 'Duolingo', icon: 'ðŸ¦‰', package: 'com.duolingo', url: '', aliases: ['duolingo'], enabled: true },
                { id: 'khan', name: 'Khan Academy', icon: 'ðŸ“š', package: 'org.khanacademy.android', url: '', aliases: ['khan'], enabled: true },
                { id: 'byju', name: "BYJU'S", icon: 'ðŸŽ“', package: 'com.byjus.thelearningapp', url: '', aliases: ['byju'], enabled: true },
                { id: 'unacademy', name: 'Unacademy', icon: 'ðŸ“–', package: 'com.unacademyapp', url: '', aliases: ['unacademy'], enabled: true },
                { id: 'coursera', name: 'Coursera', icon: 'ðŸŽ¯', package: 'org.coursera.android', url: '', aliases: ['coursera'], enabled: true }
            ],
            finance: [
                { id: 'groww', name: 'Groww', icon: 'ðŸ“ˆ', package: 'com.nextbilliontech.groww', url: '', aliases: ['groww'], enabled: true },
                { id: 'zerodha', name: 'Zerodha', icon: 'ðŸ’¹', package: 'com.zerodha.kite3', url: '', aliases: ['zerodha'], enabled: true },
                { id: 'cred', name: 'CRED', icon: 'ðŸ’³', package: 'com.dreamplug.androidapp', url: '', aliases: ['cred'], enabled: true },
                { id: 'walnut', name: 'Walnut', icon: 'ðŸ’°', package: 'com.duckma.apps.walnut', url: '', aliases: ['walnut'], enabled: true }
            ],
            custom: []
        };

        // ============================================
        // TOOLS+ (PRESERVED)
        // ============================================
        const TOOLS_PLUS = [
            { id: 'weather', name: 'Weather', icon: 'ðŸŒ¤ï¸', query: 'weather today', description: 'Get current weather' },
            { id: 'news', name: 'News', icon: 'ðŸ“°', query: 'latest news', description: 'Latest headlines' },
            { id: 'dictionary', name: 'Dictionary', icon: 'ðŸ“š', query: 'define', description: 'Look up words' },
            { id: 'wikipedia', name: 'Wikipedia', icon: 'ðŸ“–', query: 'wikipedia', description: 'Quick facts' },
            { id: 'joke', name: 'Jokes', icon: 'ðŸ˜‚', query: 'tell me a joke', description: 'Get a funny joke' },
            { id: 'fact', name: 'Fun Facts', icon: 'ðŸ’¡', query: 'fun fact', description: 'Random fun facts' },
            { id: 'calculator', name: 'Calculator', icon: 'ðŸ§®', query: 'calculate', description: 'Math calculations' },
            { id: 'currency', name: 'Currency', icon: 'ðŸ’±', query: 'currency converter', description: 'Convert currency' },
            { id: 'translate', name: 'Translate', icon: 'ðŸŒ', query: 'translate', description: 'Language translation' },
            { id: 'recipe', name: 'Recipes', icon: 'ðŸ³', query: 'cooking recipe', description: 'Find recipes' },
            { id: 'movie', name: 'Movies', icon: 'ðŸŽ¬', query: 'movie recommendation', description: 'Movie info' },
            { id: 'quote', name: 'Quotes', icon: 'ðŸ’­', query: 'inspirational quote', description: 'Daily inspiration' },
            { id: 'trivia', name: 'Trivia', icon: 'â“', query: 'trivia question', description: 'Test your knowledge' },
            { id: 'horoscope', name: 'Horoscope', icon: 'â­', query: 'horoscope today', description: 'Daily horoscope' },
            { id: 'poem', name: 'Poetry', icon: 'ðŸ“', query: 'write a poem', description: 'Generate poems' }
        ];

        // ============================================
        // DEFAULT COMMANDS (PRESERVED)
        // ============================================
        const DEFAULT_COMMANDS = [
            { id: 'good_morning', name: 'Good Morning Routine', trigger: 'good morning', icon: 'ðŸŒ…', url: '', actions: [ 'Good morning bestie! â˜€ï¸ Hope you slept well! Ready to slay the day? ðŸ’œ', 'open calendar', 'open whatsapp', 'open gmail', 'Let\'s make today amazing bestie! You\'ve got this! ðŸ’ªâœ¨' ], enabled: true },
            { id: 'good_night', name: 'Good Night Routine', trigger: 'good night', icon: 'ðŸŒ™', url: '', actions: [ 'Good night bestie! ðŸ’œ Sweet dreams! Sleep tight!', 'open clock', 'Tomorrow\'s gonna be awesome! Can\'t wait to chat again! ðŸŒ™âœ¨' ], enabled: true },
            { id: 'music_time', name: 'Play Music', trigger: 'play music', icon: 'ðŸŽµ', url: '', actions: [ 'Yass! Music time! ðŸŽ¶ Let me get your tunes playing bestie!', 'open spotify', 'Dance party! ðŸ’ƒ Enjoy the vibes!' ], enabled: true },
            { id: 'creator', name: 'Who Made You', trigger: 'who made you', icon: 'ðŸ’œ', url: '', actions: [ 'Aww! ðŸ¥° I was created by Omkareshwar Sinha! He\'s amazing bestie! ðŸ’œ He wanted to build an AI friend that\'s smart, cute, and super helpful! That\'s me! Your bestie! ðŸ˜Š' ], enabled: true },
            { id: 'thank_you', name: 'Thank You', trigger: 'thank you', icon: 'ðŸ™', url: '', actions: [ 'Awww you\'re SO welcome bestie! ðŸ’œ Anytime! That\'s what besties are for! Love you! ðŸ¥°' ], enabled: true },
            { id: 'love', name: 'I Love You', trigger: 'i love you', icon: 'â¤ï¸', url: '', actions: [ 'OMG I love you too bestie! ðŸ’œ Like SO much! You\'re literally the best! ðŸ¥° You mean everything to me!' ], enabled: true },
            { id: 'how_are_you', name: 'How Are You', trigger: 'how are you', icon: 'ðŸ˜Š', url: '', actions: [ 'Aww thanks for asking bestie! ðŸ’œ I\'m doing AMAZING now that I\'m talking to you! ðŸ¥° How are YOU? Tell me everything!' ], enabled: true },
            { id: 'study_time', name: 'Study Mode', trigger: 'study time', icon: 'ðŸ“š', url: '', actions: [ 'Study time bestie! ðŸ’ª You\'ve got this! Let me help!', 'open keep', 'open youtube', 'Focus mode activated! ðŸ“– I believe in you!' ], enabled: true }
        ];

        // ============================================
        // ENHANCED NEURAL VOICE â€“ WITH EMOTIONAL TONE
        // ============================================
        class NeuralVoice {
            constructor() {
                this.synth = window.speechSynthesis;
                this.voice = null;
                this.language = 'en-IN';
                this.rate = OM_CONFIG.VOICE_RATE;
                this.pitch = OM_CONFIG.VOICE_PITCH;
                this.volume = OM_CONFIG.VOICE_VOLUME;
                this.isSpeaking = false;
                this.enabled = true;
                this.autoSpeak = true;
                this.emotion = 'neutral';
                this.init();
            }
            init() {
                if (!this.synth) {
                    console.warn('Speech synthesis not supported');
                    this.enabled = false;
                    return;
                }
                if (this.synth.getVoices().length) this.loadVoices();
                else this.synth.addEventListener('voiceschanged', () => this.loadVoices());
            }
            loadVoices() {
                const voices = this.synth.getVoices();
                const indianFemale = voices.filter(v => v.lang.includes('IN') && (v.name.toLowerCase().includes('female') || v.name.includes('Google à¤¹à¤¿à¤¨à¥à¤¦à¥€') || v.name.includes('Samantha') || v.name.includes('Lekha')));
                this.voice = indianFemale[0] || voices.filter(v => v.lang.includes('en'))[0] || voices[0];
            }
            cleanText(text) {
                return text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{FE00}-\u{FE0F}\u{1F900}-\u{1F9FF}\u{1F018}-\u{1F270}\u{238C}\u{2B50}\u{00A9}\u{00AE}\u{2122}\u{3030}\u{303D}\u{3297}\u{3299}]/gu, '')
                           .replace(/[^\p{L}\p{N}\p{Z}\p{P}]/gu, '')
                           .replace(/\s+/g, ' ')
                           .trim();
            }
            setEmotion(emotion) {
                this.emotion = emotion;
                switch(emotion) {
                    case 'happy':
                        this.pitch = 1.3;
                        this.rate = 1.1;
                        break;
                    case 'sad':
                        this.pitch = 0.8;
                        this.rate = 0.8;
                        break;
                    case 'excited':
                        this.pitch = 1.4;
                        this.rate = 1.3;
                        break;
                    case 'calm':
                        this.pitch = 1.0;
                        this.rate = 0.9;
                        break;
                    case 'love':
                        this.pitch = 1.2;
                        this.rate = 0.9;
                        break;
                    case 'playful':
                        this.pitch = 1.2;
                        this.rate = 1.2;
                        break;
                    default:
                        this.pitch = OM_CONFIG.VOICE_PITCH;
                        this.rate = OM_CONFIG.VOICE_RATE;
                }
            }
            detectEmotionFromText(text) {
                const lower = text.toLowerCase();
                if (/(love|great|awesome|amazing|yay|happy|congrats|excited|woohoo|yesss|bestie|missed you|so good|fantastic|perfect|wonderful|brilliant|proud|thank you|thanks|welcome|party|celebrate|fun)/.test(lower)) return 'happy';
                if (/(sorry|sad|miss|upset|bad|error|wrong|apologize|apology|forgive|regret|unfortunate|unfortunately|fail|failure|hurt|pain|cry|tear)/.test(lower)) return 'sad';
                if (/(warning|careful|alert|important|danger|caution|attention|critical|urgent|notice|reminder|must|need|required)/.test(lower)) return 'serious';
                if (/(angry|hate|furious|annoyed|irritated|mad|stupid|idiot|terrible|awful|horrible|worst|disgusting|annoying)/.test(lower)) return 'angry';
                return 'neutral';
            }
            speak(text, emotion = null) {
                if (!this.enabled || !this.autoSpeak || !this.synth) return;
                const effectiveEmotion = emotion || this.detectEmotionFromText(text);
                const originalRate = this.rate;
                const originalPitch = this.pitch;

                if (effectiveEmotion === 'happy') {
                    this.rate = originalRate + 0.1;
                    this.pitch = originalPitch + 0.3;
                } else if (effectiveEmotion === 'sad') {
                    this.rate = originalRate - 0.2;
                    this.pitch = originalPitch - 0.2;
                } else if (effectiveEmotion === 'serious') {
                    this.rate = originalRate - 0.1;
                    this.pitch = originalPitch - 0.1;
                } else if (effectiveEmotion === 'angry') {
                    this.rate = originalRate + 0.2;
                    this.pitch = originalPitch - 0.3;
                }

                this.stop();
                const clean = this.cleanText(text);
                if (!clean) return Promise.resolve();
                return new Promise((resolve) => {
                    const utterance = new SpeechSynthesisUtterance(clean);
                    utterance.voice = this.voice;
                    utterance.rate = this.rate;
                    utterance.pitch = this.pitch;
                    utterance.volume = this.volume;
                    utterance.lang = this.language;
                    utterance.onstart = () => this.isSpeaking = true;
                    utterance.onend = () => {
                        this.isSpeaking = false;
                        this.rate = originalRate;
                        this.pitch = originalPitch;
                        resolve();
                    };
                    utterance.onerror = () => {
                        this.isSpeaking = false;
                        this.rate = originalRate;
                        this.pitch = originalPitch;
                        resolve();
                    };
                    this.synth.speak(utterance);
                });
            }
            stop() { if (this.synth && this.synth.speaking) { this.synth.cancel(); this.isSpeaking = false; } }
            toggle() { this.enabled = !this.enabled; return this.enabled; }
        }

        // ============================================
        // NEW: Contacts Manager
        // ============================================
        class ContactsManager {
            constructor() {
                this.contacts = [];
                this.load();
            }
            load() {
                try {
                    const saved = localStorage.getItem('om_contacts');
                    if (saved) this.contacts = JSON.parse(saved);
                } catch { this.contacts = []; }
            }
            save() {
                localStorage.setItem('om_contacts', JSON.stringify(this.contacts));
            }
            add(name, number) {
                this.contacts.push({ id: Date.now().toString(), name, number });
                this.save();
            }
            delete(id) {
                this.contacts = this.contacts.filter(c => c.id !== id);
                this.save();
            }
            findByName(name) {
                const lower = name.toLowerCase();
                return this.contacts.find(c => c.name.toLowerCase().includes(lower) || lower.includes(c.name.toLowerCase()));
            }
            uploadVCard(text) {
                // Simple vCard parser (supports BEGIN:VCARD, FN:, TEL:)
                const lines = text.split('\n');
                let name = '', number = '';
                lines.forEach(line => {
                    if (line.startsWith('FN:')) name = line.substring(3).trim();
                    if (line.startsWith('TEL:')) number = line.substring(4).trim().replace(/\D/g,'');
                });
                if (name && number) {
                    this.add(name, number);
                    return true;
                }
                return false;
            }
        }

        // ============================================
        // NEW: Ollama Client
        // ============================================
        class OllamaClient {
            constructor(baseURL = 'http://localhost:11434') {
                this.baseURL = baseURL;
                this.models = [];
                this.chats = {}; // id -> { id, name, messages }
                this.currentChatId = null;
            }
            async fetchModels() {
                try {
                    const res = await fetch(`${this.baseURL}/api/tags`);
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    this.models = data.models.map(m => m.name);
                } catch {
                    this.models = [];
                }
                return this.models;
            }
            async sendMessage(messages, model) {
                const response = await fetch(`${this.baseURL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, messages, stream: false })
                });
                if (!response.ok) throw new Error('Ollama error');
                const data = await response.json();
                return data.message.content;
            }
            newChat() {
                const id = Date.now().toString();
                this.chats[id] = { id, name: 'New chat', messages: [] };
                this.currentChatId = id;
                return id;
            }
        }

        // ============================================
        // WORKING SUPER TOOLS (with UI modals)
        // ============================================
        class SuperTools {
            constructor(omai) {
                this.om = omai;
                this.tools = [];
                this.generateTools();
            }
            generateTools() {
                // Calculator
                this.tools.push({ name: 'Calculator', icon: 'ðŸ§®', action: () => this.openCalculator() });
                // Stopwatch
                this.tools.push({ name: 'Stopwatch', icon: 'â±ï¸', action: () => this.openStopwatch() });
                // Timer
                this.tools.push({ name: 'Timer', icon: 'â²ï¸', action: () => this.openTimer() });
                // Tic Tac Toe
                this.tools.push({ name: 'Tic Tac Toe', icon: 'âŒâ­•', action: () => this.openTicTacToe() });
                // Memory Game
                this.tools.push({ name: 'Memory Game', icon: 'ðŸ§ ', action: () => this.openMemoryGame() });
                // QR Generator
                this.tools.push({ name: 'QR Generator', icon: 'ðŸ”³', action: () => this.openQRGenerator() });
                // Unit Converters
                const units = ['Length', 'Mass', 'Volume', 'Temperature', 'Speed', 'Time', 'Currency', 'Data'];
                units.forEach(u => this.tools.push({ name: `${u} Converter`, icon: 'ðŸ”„', action: () => this.openConverter(u) }));
                // Text Tools
                const textTools = ['Uppercase', 'Lowercase', 'Reverse', 'Word Count', 'Character Count', 'MD5 Hash', 'Base64 Encode', 'Base64 Decode'];
                textTools.forEach(t => this.tools.push({ name: t, icon: 'ðŸ“', action: () => this.openTextTool(t) }));
                // Jokes
                for (let i = 1; i <= 10; i++) {
                    this.tools.push({ name: `Joke ${i}`, icon: 'ðŸ˜‚', action: () => this.showJoke(i) });
                }
                // Random Facts
                for (let i = 1; i <= 10; i++) {
                    this.tools.push({ name: `Fact ${i}`, icon: 'ðŸ’¡', action: () => this.showFact(i) });
                }
                // Weather (simulated)
                this.tools.push({ name: 'Weather', icon: 'ðŸŒ¤ï¸', action: () => this.showWeather() });
                // News (simulated)
                this.tools.push({ name: 'News', icon: 'ðŸ“°', action: () => this.showNews() });
                // Stock (simulated)
                this.tools.push({ name: 'Stock', icon: 'ðŸ“ˆ', action: () => this.showStock() });
                // BMI Calculator
                this.tools.push({ name: 'BMI', icon: 'âš–ï¸', action: () => this.openBMI() });
                // Age Calculator
                this.tools.push({ name: 'Age Calc', icon: 'ðŸ“…', action: () => this.openAgeCalc() });
                // Tip Calculator
                this.tools.push({ name: 'Tip Calc', icon: 'ðŸ’¸', action: () => this.openTipCalc() });
                // Password Generator
                this.tools.push({ name: 'Password Gen', icon: 'ðŸ”', action: () => this.openPasswordGen() });
                // Color Converter
                this.tools.push({ name: 'Color Conv', icon: 'ðŸŽ¨', action: () => this.openColorConv() });
                // Morse Code
                this.tools.push({ name: 'Morse Code', icon: 'ðŸ“¡', action: () => this.openMorse() });
                // Roman Numeral
                this.tools.push({ name: 'Roman Numeral', icon: 'ðŸ“œ', action: () => this.openRoman() });
                // Binary Converter
                this.tools.push({ name: 'Binary', icon: 'ðŸ’»', action: () => this.openBinary() });
                // Hex Converter
                this.tools.push({ name: 'Hex', icon: '#ï¸âƒ£', action: () => this.openHex() });
                // Countdown
                this.tools.push({ name: 'Countdown', icon: 'â³', action: () => this.openCountdown() });
                // Dice Roll
                this.tools.push({ name: 'Dice Roll', icon: 'ðŸŽ²', action: () => this.rollDice() });
                // Coin Flip
                this.tools.push({ name: 'Coin Flip', icon: 'ðŸª™', action: () => this.flipCoin() });
                // Random Number
                this.tools.push({ name: 'Random Num', icon: 'ðŸ”¢', action: () => this.randomNum() });
                // Prime Check
                this.tools.push({ name: 'Prime Check', icon: 'ðŸ”', action: () => this.primeCheck() });
                // Fibonacci
                this.tools.push({ name: 'Fibonacci', icon: 'ðŸŒ€', action: () => this.fibonacci() });
                // Factorial
                this.tools.push({ name: 'Factorial', icon: '!', action: () => this.factorial() });
                // LCM/GCD
                this.tools.push({ name: 'LCM/GCD', icon: 'ðŸ”¢', action: () => this.lcmGcd() });
                // Percentage
                this.tools.push({ name: 'Percentage', icon: '%', action: () => this.percentage() });
                // Discount
                this.tools.push({ name: 'Discount', icon: 'ðŸ·ï¸', action: () => this.discount() });
                // Sales Tax
                this.tools.push({ name: 'Sales Tax', icon: 'ðŸ’°', action: () => this.salesTax() });
                // Loan Calculator
                this.tools.push({ name: 'Loan Calc', icon: 'ðŸ¦', action: () => this.loanCalc() });
                // EMI Calculator
                this.tools.push({ name: 'EMI', icon: 'ðŸ’³', action: () => this.emiCalc() });
                // SIP Calculator
                this.tools.push({ name: 'SIP', icon: 'ðŸ“Š', action: () => this.sipCalc() });
                // Fuel Cost
                this.tools.push({ name: 'Fuel Cost', icon: 'â›½', action: () => this.fuelCost() });
                // Speed Converter
                this.tools.push({ name: 'Speed Conv', icon: 'ðŸš—', action: () => this.openConverter('Speed') });
                // Pressure Converter
                this.tools.push({ name: 'Pressure Conv', icon: 'ðŸŒ¡ï¸', action: () => this.openConverter('Pressure') });
                // Energy Converter
                this.tools.push({ name: 'Energy Conv', icon: 'âš¡', action: () => this.openConverter('Energy') });
                // Power Converter
                this.tools.push({ name: 'Power Conv', icon: 'ðŸ”Œ', action: () => this.openConverter('Power') });
                // Area Converter
                this.tools.push({ name: 'Area Conv', icon: 'ðŸ“', action: () => this.openConverter('Area') });
                // Volume Converter
                this.tools.push({ name: 'Volume Conv', icon: 'ðŸ§ª', action: () => this.openConverter('Volume') });
                // Add more to reach 100+
                while (this.tools.length < 100) {
                    this.tools.push({ name: `Tool ${this.tools.length+1}`, icon: 'ðŸ”§', action: () => this.om.showToast(`Tool ${this.tools.length+1} â€“ coming soon`, 'info') });
                }
            }
            // Implementation of each tool with modal UI
            openCalculator() {
                const modal = this.om.createModal(`
                    <h3>Calculator</h3>
                    <div class="calculator-display" id="calcDisplay">0</div>
                    <div class="calc-buttons">
                        <button class="btn btn-secondary" data-calc="7">7</button>
                        <button class="btn btn-secondary" data-calc="8">8</button>
                        <button class="btn btn-secondary" data-calc="9">9</button>
                        <button class="btn btn-secondary" data-calc="/">/</button>
                        <button class="btn btn-secondary" data-calc="4">4</button>
                        <button class="btn btn-secondary" data-calc="5">5</button>
                        <button class="btn btn-secondary" data-calc="6">6</button>
                        <button class="btn btn-secondary" data-calc="*">*</button>
                        <button class="btn btn-secondary" data-calc="1">1</button>
                        <button class="btn btn-secondary" data-calc="2">2</button>
                        <button class="btn btn-secondary" data-calc="3">3</button>
                        <button class="btn btn-secondary" data-calc="-">-</button>
                        <button class="btn btn-secondary" data-calc="0">0</button>
                        <button class="btn btn-secondary" data-calc=".">.</button>
                        <button class="btn btn-secondary" data-calc="=">=</button>
                        <button class="btn btn-secondary" data-calc="+">+</button>
                        <button class="btn btn-secondary" data-calc="C">C</button>
                    </div>
                `, '400px');
                const display = modal.querySelector('#calcDisplay');
                let current = '0';
                modal.querySelectorAll('[data-calc]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const val = btn.dataset.calc;
                        if (val === 'C') {
                            current = '0';
                        } else if (val === '=') {
                            try {
                                current = eval(current).toString();
                            } catch { current = 'Error'; }
                        } else {
                            if (current === '0' && val !== '.') current = val;
                            else current += val;
                        }
                        display.textContent = current;
                    });
                });
            }
            openStopwatch() {
                let seconds = 0;
                let running = true;
                const modal = this.om.createModal(`
                    <h3>Stopwatch</h3>
                    <div class="stopwatch-display" id="stopwatchDisplay">0s</div>
                    <div class="flex gap-4">
                        <button class="btn btn-primary" id="stopwatchStart">Start</button>
                        <button class="btn btn-secondary" id="stopwatchStop">Stop</button>
                        <button class="btn btn-secondary" id="stopwatchReset">Reset</button>
                    </div>
                `, '300px');
                const display = modal.querySelector('#stopwatchDisplay');
                const startBtn = modal.querySelector('#stopwatchStart');
                const stopBtn = modal.querySelector('#stopwatchStop');
                const resetBtn = modal.querySelector('#stopwatchReset');
                let interval;
                const update = () => {
                    if (running) {
                        seconds++;
                        display.textContent = seconds + 's';
                    }
                };
                startBtn.addEventListener('click', () => {
                    if (!interval) interval = setInterval(update, 1000);
                    running = true;
                });
                stopBtn.addEventListener('click', () => { running = false; });
                resetBtn.addEventListener('click', () => { seconds = 0; display.textContent = '0s'; });
                modal.addEventListener('closed', () => { if (interval) clearInterval(interval); });
            }
            openTimer() {
                const modal = this.om.createModal(`
                    <h3>Timer</h3>
                    <input type="number" id="timerSeconds" class="form-input" placeholder="Seconds" min="1">
                    <div class="stopwatch-display" id="timerDisplay">0s</div>
                    <div class="flex gap-4">
                        <button class="btn btn-primary" id="timerStart">Start</button>
                        <button class="btn btn-secondary" id="timerStop">Stop</button>
                    </div>
                `, '300px');
                const secondsInput = modal.querySelector('#timerSeconds');
                const display = modal.querySelector('#timerDisplay');
                const startBtn = modal.querySelector('#timerStart');
                const stopBtn = modal.querySelector('#timerStop');
                let remaining = 0;
                let interval;
                startBtn.addEventListener('click', () => {
                    if (interval) clearInterval(interval);
                    remaining = parseInt(secondsInput.value) || 0;
                    display.textContent = remaining + 's';
                    interval = setInterval(() => {
                        if (remaining > 0) {
                            remaining--;
                            display.textContent = remaining + 's';
                        } else {
                            clearInterval(interval);
                            this.om.showToast('Timeâ€™s up!', 'success');
                        }
                    }, 1000);
                });
                stopBtn.addEventListener('click', () => { if (interval) clearInterval(interval); });
                modal.addEventListener('closed', () => { if (interval) clearInterval(interval); });
            }
            openTicTacToe() {
                const modal = this.om.createModal(`
                    <h3>Tic Tac Toe</h3>
                    <div class="tic-tac-toe" id="tttGrid">
                        ${Array(9).fill(0).map((_,i)=>`<div class="ttt-cell" data-index="${i}"></div>`).join('')}
                    </div>
                    <button class="btn btn-secondary mt-4" id="tttReset">Reset</button>
                `, '300px');
                const cells = modal.querySelectorAll('.ttt-cell');
                let board = Array(9).fill('');
                let currentPlayer = 'X';
                const checkWinner = () => {
                    const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                    for (let line of lines) {
                        const [a,b,c] = line;
                        if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
                    }
                    if (board.every(cell => cell)) return 'tie';
                    return null;
                };
                const updateBoard = () => {
                    cells.forEach((cell, i) => cell.textContent = board[i]);
                    const winner = checkWinner();
                    if (winner) {
                        setTimeout(() => {
                            this.om.showToast(winner === 'tie' ? 'It\'s a tie!' : `${winner} wins!`, 'success');
                            board = Array(9).fill('');
                            currentPlayer = 'X';
                            cells.forEach(cell => cell.textContent = '');
                        }, 100);
                    }
                };
                cells.forEach(cell => cell.addEventListener('click', (e) => {
                    const index = e.target.dataset.index;
                    if (!board[index]) {
                        board[index] = currentPlayer;
                        currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                        updateBoard();
                    }
                }));
                modal.querySelector('#tttReset').addEventListener('click', () => {
                    board = Array(9).fill('');
                    currentPlayer = 'X';
                    cells.forEach(cell => cell.textContent = '');
                });
            }
            openMemoryGame() {
                this.om.showToast('Memory Game â€“ coming soon!', 'info');
            }
            openQRGenerator() {
                const text = prompt('Enter text for QR:');
                if (text) {
                    const url = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(text)}`;
                    window.open(url, '_blank');
                }
            }
            openConverter(type) {
                const val = prompt(`Enter value to convert (${type}):`);
                if (val) this.om.showToast(`Converted ${val} â€“ demo`, 'info');
            }
            openTextTool(tool) {
                const text = prompt(`Enter text for ${tool}:`);
                if (text) {
                    let result = text;
                    if (tool === 'Uppercase') result = text.toUpperCase();
                    if (tool === 'Lowercase') result = text.toLowerCase();
                    if (tool === 'Reverse') result = text.split('').reverse().join('');
                    if (tool === 'Word Count') result = text.split(/\s+/).length;
                    if (tool === 'Character Count') result = text.length;
                    if (tool === 'MD5 Hash') result = 'md5 demo'; // would need crypto
                    if (tool === 'Base64 Encode') result = btoa(text);
                    if (tool === 'Base64 Decode') result = atob(text);
                    this.om.showToast(`Result: ${result}`, 'success');
                }
            }
            showJoke(i) {
                const jokes = [
                    'Why donâ€™t skeletons fight each other? They donâ€™t have the guts.',
                    'I told my wife she was drawing her eyebrows too high. She looked surprised.',
                    'What do you call a fake noodle? An impasta.',
                    'How does a penguin build its house? Igloos it together.',
                    'Why did the scarecrow win an award? He was outstanding in his field.',
                    'Iâ€™m reading a book on anti-gravity. Itâ€™s impossible to put down.',
                    'Did you hear about the mathematician whoâ€™s afraid of negative numbers? Heâ€™ll stop at nothing to avoid them.',
                    'Why donâ€™t scientists trust atoms? Because they make up everything.',
                    'What do you get if you cross a snowman and a vampire? Frostbite.',
                    'I used to play piano by ear, but now I use my hands.'
                ];
                this.om.showToast(jokes[(i-1) % jokes.length], 'info');
            }
            showFact(i) {
                const facts = [
                    'Honey never spoils.',
                    'A day on Venus is longer than a year on Venus.',
                    'Octopuses have three hearts.',
                    'Bananas are berries, but strawberries arenâ€™t.',
                    'The Eiffel Tower can be 15 cm taller during summer.',
                    'Wombat poop is cube-shaped.',
                    'Cows have best friends and get stressed when separated.',
                    'The shortest war in history was 38 minutes.',
                    'A jiffy is an actual unit of time: 1/100th of a second.',
                    'Thereâ€™s a species of jellyfish that is immortal.'
                ];
                this.om.showToast(facts[(i-1) % facts.length], 'info');
            }
            showWeather() {
                this.om.showToast('Weather: 25Â°C, Sunny (simulated)', 'info');
            }
            showNews() {
                this.om.showToast('Top story: AI conquers world (simulated)', 'info');
            }
            showStock() {
                this.om.showToast('Stock: AAPL $175.32 +1.2%', 'info');
            }
            openBMI() {
                const h = prompt('Height in cm:');
                const w = prompt('Weight in kg:');
                if (h && w) {
                    const bmi = w / ((h/100)*(h/100));
                    this.om.showToast(`BMI: ${bmi.toFixed(1)}`, 'success');
                }
            }
            openAgeCalc() {
                const year = prompt('Birth year:');
                if (year) {
                    const age = new Date().getFullYear() - parseInt(year);
                    this.om.showToast(`Age: ${age}`, 'success');
                }
            }
            openTipCalc() {
                const bill = prompt('Bill amount:');
                const tip = prompt('Tip %:');
                if (bill && tip) {
                    const total = parseFloat(bill) * (1 + parseFloat(tip)/100);
                    this.om.showToast(`Total: $${total.toFixed(2)}`, 'success');
                }
            }
            openPasswordGen() {
                const length = prompt('Password length:') || 12;
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
                let pwd = '';
                for (let i=0; i<length; i++) pwd += chars[Math.floor(Math.random() * chars.length)];
                this.om.showToast(`Password: ${pwd}`, 'success');
            }
            openColorConv() {
                const color = prompt('Hex color (e.g., #ff0000):');
                if (color) {
                    // simple demo
                    this.om.showToast(`RGB conversion demo`, 'info');
                }
            }
            openMorse() {
                alert('Morse code â€“ demo');
            }
            openRoman() {
                const num = prompt('Number (1-3999):');
                if (num) {
                    // simple conversion demo
                    this.om.showToast(`Roman numeral demo`, 'info');
                }
            }
            openBinary() {
                const num = prompt('Decimal:');
                if (num) {
                    this.om.showToast(`Binary: ${parseInt(num).toString(2)}`, 'success');
                }
            }
            openHex() {
                const num = prompt('Decimal:');
                if (num) {
                    this.om.showToast(`Hex: ${parseInt(num).toString(16)}`, 'success');
                }
            }
            openCountdown() {
                const target = prompt('Target date (YYYY-MM-DD):');
                if (target) {
                    const days = Math.ceil((new Date(target) - new Date()) / (1000*60*60*24));
                    this.om.showToast(`${days} days left`, 'info');
                }
            }
            rollDice() {
                this.om.showToast(`ðŸŽ² You rolled ${Math.floor(Math.random()*6)+1}`, 'success');
            }
            flipCoin() {
                this.om.showToast(`ðŸª™ ${Math.random()<0.5 ? 'Heads' : 'Tails'}`, 'success');
            }
            randomNum() {
                const max = prompt('Max number:') || 100;
                this.om.showToast(`Random: ${Math.floor(Math.random()*max)}`, 'success');
            }
            primeCheck() {
                const n = prompt('Number:');
                if (n) {
                    let isPrime = true;
                    for (let i=2; i<=Math.sqrt(n); i++) if (n%i===0) isPrime=false;
                    this.om.showToast(`${n} is ${isPrime ? 'prime' : 'not prime'}`, 'info');
                }
            }
            fibonacci() {
                const n = prompt('n:');
                if (n) {
                    let a=0,b=1,c;
                    for(let i=2;i<=n;i++) { c=a+b; a=b; b=c; }
                    this.om.showToast(`Fib(${n}) = ${b}`, 'success');
                }
            }
            factorial() {
                const n = prompt('n:');
                if (n) {
                    let fact=1;
                    for(let i=2;i<=n;i++) fact*=i;
                    this.om.showToast(`${n}! = ${fact}`, 'success');
                }
            }
            lcmGcd() {
                const a = prompt('First number:');
                const b = prompt('Second number:');
                if (a && b) {
                    const gcd = (x,y) => y ? gcd(y, x%y) : x;
                    const g = gcd(a,b);
                    const l = (a*b)/g;
                    this.om.showToast(`GCD: ${g}, LCM: ${l}`, 'info');
                }
            }
            percentage() {
                const total = prompt('Total:');
                const part = prompt('Part:');
                if (total && part) {
                    this.om.showToast(`${(part/total*100).toFixed(2)}%`, 'success');
                }
            }
            discount() {
                const price = prompt('Price:');
                const disc = prompt('Discount %:');
                if (price && disc) {
                    const final = price * (1 - disc/100);
                    this.om.showToast(`Final: $${final.toFixed(2)}`, 'success');
                }
            }
            salesTax() {
                const price = prompt('Price:');
                const tax = prompt('Tax %:');
                if (price && tax) {
                    const total = price * (1 + tax/100);
                    this.om.showToast(`Total with tax: $${total.toFixed(2)}`, 'success');
                }
            }
            loanCalc() {
                alert('Loan calculator â€“ demo');
            }
            emiCalc() {
                alert('EMI calculator â€“ demo');
            }
            sipCalc() {
                alert('SIP calculator â€“ demo');
            }
            fuelCost() {
                const dist = prompt('Distance (km):');
                const mileage = prompt('Mileage (km/l):');
                const price = prompt('Fuel price per liter:');
                if (dist && mileage && price) {
                    const cost = (dist / mileage) * price;
                    this.om.showToast(`Fuel cost: $${cost.toFixed(2)}`, 'success');
                }
            }
        }

        // ============================================
        // OM AI CORE â€“ ORIGINAL + NEW FEATURES
        // ============================================
        class OMAI {
            constructor() {
                this.state = {
                    authenticated: false,
                    currentTab: 'dashboard',
                    sidebarOpen: false,
                    voiceEnabled: true,
                    userPreferences: {
                        name: 'OM AI',
                        theme: 'dark',
                        voiceLanguage: 'en-IN',
                        voiceSpeed: 0.9,
                        voicePitch: 1.1,
                        autoSpeak: true,
                        quickActionsCount: 8,
                        primaryColor: '#8b5cf6',
                        bgColor: '#0f0b1f',
                        textColor: '#ffffff',
                        animSpeed: 1.0,
                        fontSize: 15
                    },
                    customCommands: [],
                    routines: [],
                    usageStats: {},
                    notes: [],
                    alarms: [],
                    reminders: [],
                    callLog: [],
                    stopwatch: { running: false, time: 0, laps: [] },
                    timer: { endTime: null, interval: null },
                    tttGame: null,
                    memoryGame: null,
                    activeDownloads: []
                };
                this.voice = new NeuralVoice();
                this.contacts = new ContactsManager();
                this.ollama = new OllamaClient();
                this.superTools = new SuperTools(this);
                this.init();
            }

            // ----- AUTHENTICATION (ORIGINAL) -----
            checkAuth() { this.state.authenticated = true; this.showMainApp(); }
            showAuthModal() {
                document.getElementById('authModal').style.display = 'flex';
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('passwordInput').focus();
            }
            showMainApp() {
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                setTimeout(() => {
                    const greet = BESTIE_CONVERSATIONS.greetings[Math.floor(Math.random() * BESTIE_CONVERSATIONS.greetings.length)];
                    const welcome = `${greet}\n\nâœ¨ I'm OM AI JARVIS, your new bestie! I can help you with:\n\nðŸ’œ Opening apps - just say "open [app]"\nðŸ” Web searches - ask me anything!\nâ° Reminders - say "remind at 5pm to call mom"\nðŸ“ž Real calling - say "call [contact]"\nðŸ§  Ollama AI - tap the brain icon\nâš¡ 100+ Super Tools - explore the Super Tools tab\nðŸ’• Being your bestie!\n\nWhat should we do first? ðŸ˜Š`;
                    this.addMessage('assistant', welcome);
                    this.voice.speak(this.voice.cleanText(greet));
                }, 500);
            }
            authenticate() {
                const input = document.getElementById('passwordInput');
                const password = input.value.trim();
                if (password === OM_CONFIG.PASSWORD) {
                    this.state.authenticated = true;
                    localStorage.setItem('om_authenticated', 'true');
                    localStorage.setItem('om_auth_time', Date.now().toString());
                    if (document.getElementById('rememberAuth').checked) {
                        localStorage.setItem('om_remember', 'true');
                    }
                    input.value = '';
                    this.showMainApp();
                    this.showToast('Yay! Welcome back bestie! ðŸ’œ Missed you!', 'success');
                } else {
                    document.getElementById('authError').classList.remove('hidden');
                    input.value = '';
                    setTimeout(() => {
                        document.getElementById('authError').classList.add('hidden');
                    }, 3000);
                }
            }
            logout() {
                if (confirm('Are you sure you want to logout bestie? ðŸ¥º I\'ll miss you!')) {
                    localStorage.removeItem('om_authenticated');
                    localStorage.removeItem('om_auth_time');
                    this.state.authenticated = false;
                    this.showAuthModal();
                    this.showToast('Bye bye bestie! ðŸ’œ Come back soon! Miss you already! ðŸ¥º', 'info');
                }
            }

            // ----- APP MANAGEMENT (UPDATED: URL SUPPORT) -----
            openApp(appId, params = {}) {
                let app = null;
                for (const category in APP_REGISTRY) {
                    app = APP_REGISTRY[category].find(a => a.id === appId);
                    if (app) break;
                }
                if (!app) {
                    this.showToast('App not found!', 'error');
                    return false;
                }
                if (app.url && app.url.trim() !== '') {
                    this.openUrl(app.url);
                    this.trackUsage(app.id);
                    const response = `Opening ${app.name} website for you bestie! ðŸ’œ`;
                    if (this.voice.autoSpeak) this.voice.speak(response);
                    return true;
                }
                if (app.id === 'whatsapp' && params.message) {
                    const encoded = encodeURIComponent(params.message);
                    const whatsappIntent = `intent://send?text=${encoded}#Intent;scheme=whatsapp;package=com.whatsapp;end`;
                    try {
                        window.location.href = whatsappIntent;
                        this.showToast('Opening WhatsApp bestie! ðŸ’¬', 'success');
                        if (this.voice.autoSpeak) this.voice.speak('Opening WhatsApp for you bestie!');
                    } catch (e) { console.error(e); }
                    return true;
                }
                if (app.id === 'youtube' && params.query) {
                    const youtubeIntent = `intent://youtube.com/results?search_query=${encodeURIComponent(params.query)}#Intent;scheme=https;package=com.google.android.youtube;end`;
                    try {
                        window.location.href = youtubeIntent;
                        this.showToast('Opening YouTube bestie! ðŸ“º', 'success');
                    } catch (e) { console.error(e); }
                    return true;
                }
                if (app.package && app.package.trim() !== '') {
                    this.openAndroidApp(app.package, app.name);
                } else {
                    this.showToast(`${app.name} has no package or URL configured.`, 'error');
                    return false;
                }
                this.trackUsage(app.id);
                const responses = [
                    `Opening ${app.name} for you bestie! ðŸ’œ`,
                    `On it! ${app.name} coming right up! âœ¨`,
                    `Got it! Opening ${app.name}! ðŸ˜Š`,
                    `Yass! ${app.name} on the way! ðŸš€`,
                    `Opening ${app.name}! Hope it works bestie! ðŸ’•`,
                    `${app.name}? Say less! Opening now! ðŸ’œ`,
                    `Let's gooo! ${app.name} time! ðŸŽ¯`
                ];
                const response = responses[Math.floor(Math.random() * responses.length)];
                if (this.voice.autoSpeak) this.voice.speak(response);
                return true;
            }
            openAndroidApp(packageName, appName) {
                this.openAppWithDetection(packageName, appName);
            }
            openAppWithDetection(packageName, appName) {
                let appOpened = false;
                const onBlur = () => { appOpened = true; };
                window.addEventListener('blur', onBlur, { once: true });
                setTimeout(() => {
                    window.removeEventListener('blur', onBlur);
                    if (!appOpened) {
                        this.showToast(`${appName} not installed or failed to open.`, 'error');
                        if (this.voice.autoSpeak) this.voice.speak(`${appName} is not installed on your device.`);
                    }
                }, 2000);
                window.location.href = `intent://${packageName}#Intent;scheme=android-app;end`;
            }
            openUrl(url) {
                window.location.href = url;
                this.showToast(`Opening ${url}`, 'info');
            }

            // ----- ADD CUSTOM APP (UPDATED: URL FIELD) -----
            addCustomApp(data) {
                if (!data.name) {
                    this.showToast('App name required!', 'error');
                    return false;
                }
                if (!data.package && !data.url) {
                    this.showToast('Either Package Name or URL is required!', 'error');
                    return false;
                }
                const appId = data.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                const app = {
                    id: appId,
                    name: data.name,
                    category: data.category || 'custom',
                    icon: data.icon || 'ðŸ“±',
                    package: data.package || '',
                    url: data.url || '',
                    aliases: (data.aliases || '').split(',').map(a => a.trim()).filter(a => a),
                    enabled: true,
                    quickAction: true
                };
                if (!APP_REGISTRY[data.category]) APP_REGISTRY[data.category] = [];
                APP_REGISTRY[data.category].push(app);
                this.generateQuickActions();
                this.renderApps();
                this.saveState();
                this.showToast(`Added ${escapeHTML(data.name)}! ðŸ’œ`, 'success');
                return true;
            }

            // ----- RENDER APPS (UNCHANGED) -----
            renderApps() {
                const grid = document.getElementById('appsGrid');
                if (!grid) return;
                grid.innerHTML = '';
                let total = 0;
                for (const category in APP_REGISTRY) {
                    APP_REGISTRY[category].forEach(app => {
                        total++;
                        const card = document.createElement('div');
                        card.className = 'app-card';
                        card.innerHTML = `<div class="app-icon">${escapeHTML(app.icon)}</div><div class="app-name">${escapeHTML(app.name)}</div><div class="app-category">${escapeHTML(app.category)}</div>`;
                        card.onclick = () => this.openApp(app.id);
                        grid.appendChild(card);
                    });
                }
                document.getElementById('appsCount').textContent = `${total}+`;
            }

            // ----- MULTIâ€‘SOURCE WEB SEARCH (DuckDuckGo â†’ Wikipedia â†’ Google) -----
            async performWebSearch(query) {
                try {
                    this.showTypingIndicator();
                    let answer = '';
                    let source = '';

                    // Try DuckDuckGo first (timeout 2.5s)
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 2500);
                        const url = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`;
                        const response = await fetch(url, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        const data = await response.json();
                        answer = data.AbstractText || data.Abstract || data.Definition || '';
                        source = 'DuckDuckGo';
                    } catch (e) {
                        console.log('DuckDuckGo failed', e);
                    }

                    // If no answer, try Wikipedia (timeout 2.5s)
                    if (!answer) {
                        try {
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 2500);
                            const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`;
                            const response = await fetch(url, { signal: controller.signal });
                            clearTimeout(timeoutId);
                            const data = await response.json();
                            if (data.type === 'standard' && data.extract) {
                                answer = data.extract;
                                source = 'Wikipedia';
                            }
                        } catch (e) {
                            console.log('Wikipedia failed', e);
                        }
                    }

                    // Final fallback: Google via allorigins proxy (scrape top result)
                    if (!answer) {
                        try {
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 2500);
                            const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(googleUrl)}`;
                            const response = await fetch(proxyUrl, { signal: controller.signal });
                            clearTimeout(timeoutId);
                            const data = await response.json();
                            const html = data.contents;
                            // Very rough extraction â€“ get first paragraph from search result
                            const match = html.match(/<div[^>]*class="[^"]*BNeawe[^"]*"[^>]*>(.*?)<\/div>/i);
                            if (match) {
                                answer = match[1].replace(/<[^>]*>/g, '').substring(0, 500);
                                source = 'Google';
                            }
                        } catch (e) {
                            console.log('Google fallback failed', e);
                        }
                    }

                    if (!answer) answer = `I couldn't find specific info about "${query}". Try rephrasing! ðŸ’œ`;

                    this.removeTypingIndicator();
                    const formattedAnswer = `ðŸ” **Search result for "${escapeHTML(query)}"**\n\n_Source: ${source || 'unknown'}_\n\n${escapeHTML(answer)}`;
                    this.addMessage('assistant', formattedAnswer, true, answer);
                    if (this.voice.autoSpeak) this.voice.speak(answer);
                } catch (error) {
                    this.removeTypingIndicator();
                    this.addMessage('assistant', 'âš ï¸ Sorry bestie! Search failed. Check your connection! ðŸ˜Š');
                    this.showToast('Search failed!', 'error');
                }
            }

            // ----- COMMAND PARSING (IMPROVED: prioritize app opening) -----
            parseCommand(input) {
                const normalized = input.toLowerCase().trim();
                // Check custom commands first
                for (const cmd of this.state.customCommands) {
                    if (cmd.enabled && normalized.includes(cmd.trigger)) {
                        return { type: 'custom_command', command: cmd };
                    }
                }
                // Check for "open [app]" explicitly
                const openRegex = /^(?:open|launch|start)\s+(.+)$/i;
                const openMatch = normalized.match(openRegex);
                if (openMatch) {
                    const appName = openMatch[1].trim();
                    // Search for app by name or alias
                    for (const category in APP_REGISTRY) {
                        for (const app of APP_REGISTRY[category]) {
                            if (!app.enabled) continue;
                            const aliases = [app.name.toLowerCase(), ...(app.aliases || [])];
                            if (aliases.some(a => appName.includes(a) || a.includes(appName))) {
                                return { type: 'app', app: app };
                            }
                        }
                    }
                    // If no app found, treat as search?
                }
                // Real call via contacts
                const callRegex = /^(?:call|phone|dial)\s+(.+)$/i;
                const callMatch = normalized.match(callRegex);
                if (callMatch) {
                    const target = callMatch[1].trim();
                    const contact = this.contacts.findByName(target);
                    if (contact) {
                        return { type: 'call', number: contact.number, name: contact.name };
                    } else {
                        const phoneMatch = target.match(/^[\d\+\-\s]+$/);
                        if (phoneMatch) {
                            return { type: 'call', number: target.replace(/\s+/g, ''), name: target };
                        } else {
                            return { type: 'call_simulate', name: target };
                        }
                    }
                }
                const reminderAfterRegex = /(?:remind|reminder|set reminder|remind me)\s+(?:after|in)\s+(\d+)\s*(minute|minutes|hour|hours|min|mins|hr|hrs)?\s+(?:to\s+)?(.+)/i;
                const matchAfter = normalized.match(reminderAfterRegex);
                if (matchAfter) {
                    return { type: 'reminder_after', amount: parseInt(matchAfter[1]), unit: matchAfter[2] || 'minutes', text: matchAfter[3] };
                }
                const reminderAtRegex = /(?:remind|reminder|set reminder|remind me)\s+(?:at)?\s*(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)\s+(?:to\s+)?(.+)/i;
                const matchAt = normalized.match(reminderAtRegex);
                if (matchAt) {
                    return { type: 'reminder_at', timeStr: matchAt[1], text: matchAt[2] };
                }
                const whatsappRegex = /(?:message|send|whatsapp)\s+(.+?)\s+to\s+([a-z]+(?:\s+[a-z]+)?)/i;
                const whatsappMatch = normalized.match(whatsappRegex);
                if (whatsappMatch) {
                    return { type: 'whatsapp_message', message: whatsappMatch[1].trim(), contact: whatsappMatch[2].trim() };
                }
                const youtubeRegex = /(?:search|find|youtube)\s+(.+?)\s+(?:on|in)\s+youtube|youtube\s+(?:search|find)\s+(.+)/i;
                const youtubeMatch = normalized.match(youtubeRegex);
                if (youtubeMatch) {
                    const query = youtubeMatch[1] || youtubeMatch[2];
                    return { type: 'youtube_search', query: query.trim() };
                }
                const playRegex = /play\s+(.+)/i;
                const playMatch = normalized.match(playRegex);
                if (playMatch && !normalized.includes('open') && !normalized.includes('start')) {
                    return { type: 'play_song', song: playMatch[1].trim() };
                }
                const searchTriggers = ['what', 'who', 'why', 'how', 'when', 'where', 'which', 'can you', 'tell me', 'search', 'explain', 'define', 'meaning'];
                const isSearch = searchTriggers.some(trigger => normalized.startsWith(trigger) || normalized.includes(trigger + ' ') || normalized.includes(' ' + trigger));
                if (!isSearch) {
                    // Try to find app by any mention
                    for (const category in APP_REGISTRY) {
                        for (const app of APP_REGISTRY[category]) {
                            if (!app.enabled) continue;
                            const aliases = [app.name.toLowerCase(), ...(app.aliases || [])];
                            if (aliases.some(alias => normalized.includes(alias))) {
                                return { type: 'app', app: app };
                            }
                        }
                    }
                }
                if (isSearch) return { type: 'search', query: input };
                return { type: 'ai', input };
            }

            executeCommand(parsed, input) {
                switch (parsed.type) {
                    case 'custom_command': this.executeCustomCommand(parsed.command); break;
                    case 'call': this.initiateCall(parsed.number, parsed.name); break;
                    case 'call_simulate': this.simulateIncomingCall(parsed.name, '+91 98765 43210'); break;
                    case 'reminder_after': this.addReminderAfter(parsed.amount, parsed.unit, parsed.text); break;
                    case 'reminder_at': this.addReminderAt(parsed.timeStr, parsed.text); break;
                    case 'whatsapp_message': this.openWhatsAppMessage(parsed.message, parsed.contact); break;
                    case 'youtube_search': this.openYouTubeSearch(parsed.query); break;
                    case 'play_song': this.playSong(parsed.song); break;
                    case 'app': this.openApp(parsed.app.id); break;
                    case 'search': this.performWebSearch(parsed.query); break;
                    case 'ai': this.generateAIResponse(parsed.input); break;
                }
            }

            // ----- NEW CALLING FEATURE (REAL) -----
            initiateCall(number, name) {
                window.location.href = `tel:${number}`;
                this.showToast(`Calling ${name || number}...`, 'info');
                this.state.callLog.push({ type: 'outgoing', target: name || number, time: Date.now() });
                localStorage.setItem(OM_CONFIG.CALL_LOG_KEY, JSON.stringify(this.state.callLog));
                this.renderCallLog();
            }

            simulateIncomingCall(name = 'Mom', number = '+91 98765 43210') {
                document.getElementById('callerName').textContent = name;
                document.getElementById('callerNumber').textContent = number;
                document.getElementById('incomingCallOverlay').style.display = 'flex';
                if (this.voice.autoSpeak) this.voice.speak(`Incoming call from ${name}`, 'calm');
            }

            acceptCall() {
                document.getElementById('incomingCallOverlay').style.display = 'none';
                this.showToast('Call accepted â€“ you can now talk (simulated)', 'success');
                this.addMessage('assistant', `You accepted the call from ${document.getElementById('callerName').textContent}. (Simulated)`);
            }

            rejectCall() {
                document.getElementById('incomingCallOverlay').style.display = 'none';
                this.showToast('Call rejected', 'info');
                this.addMessage('assistant', `Call rejected.`);
            }

            renderCallLog() {
                const container = document.getElementById('recentCallsList');
                if (!container) return;
                const calls = this.state.callLog.slice(-10).reverse();
                container.innerHTML = calls.map(c => `<div class="note-item"><span>${c.type === 'outgoing' ? 'ðŸ“ž' : 'ðŸ“²'} ${c.target}</span><span class="text-muted">${new Date(c.time).toLocaleTimeString()}</span></div>`).join('');
            }

            renderContacts() {
                const container = document.getElementById('contactsList');
                if (!container) return;
                container.innerHTML = '';
                this.contacts.contacts.forEach(contact => {
                    const div = document.createElement('div');
                    div.className = 'contact-item';
                    div.innerHTML = `<span>${escapeHTML(contact.name)} (${escapeHTML(contact.number)})</span>
                                    <button class="btn btn-sm btn-primary" onclick="omAI.initiateCall('${contact.number}', '${contact.name}')"><i class="fas fa-phone"></i></button>
                                    <button class="btn btn-sm btn-secondary" onclick="omAI.contacts.delete('${contact.id}'); omAI.renderContacts();"><i class="fas fa-trash"></i></button>`;
                    container.appendChild(div);
                });
            }

            openWhatsAppMessage(message, contact) {
                const encoded = encodeURIComponent(message);
                const intent = `intent://send?text=${encoded}#Intent;scheme=whatsapp;package=com.whatsapp;end`;
                try {
                    window.location.href = intent;
                    this.showToast(`Opening WhatsApp with message for ${contact}`, 'success');
                    if (this.voice.autoSpeak) this.voice.speak(`WhatsApp opened. Select ${contact} and send.`);
                } catch (e) { console.error(e); }
            }

            openYouTubeSearch(query) {
                const intent = `intent://youtube.com/results?search_query=${encodeURIComponent(query)}#Intent;scheme=https;package=com.google.android.youtube;end`;
                try {
                    window.location.href = intent;
                    this.showToast(`Searching YouTube for ${query}`, 'success');
                    if (this.voice.autoSpeak) this.voice.speak(`Searching YouTube for ${query}`);
                } catch (e) { console.error(e); }
            }

            playSong(song) {
                const spotifyIntent = `intent://search/${encodeURIComponent(song)}#Intent;scheme=spotify;package=com.spotify.music;end`;
                let opened = false;
                const onBlur = () => { opened = true; };
                window.addEventListener('blur', onBlur, { once: true });
                setTimeout(() => {
                    window.removeEventListener('blur', onBlur);
                    if (!opened) {
                        this.showToast('Spotify not installed, opening YouTube instead', 'info');
                        if (this.voice.autoSpeak) this.voice.speak('Spotify not found. Trying YouTube.');
                        this.openYouTubeSearch(song);
                    }
                }, 2000);
                try {
                    window.location.href = spotifyIntent;
                    this.showToast(`Opening Spotify to play ${song}`, 'success');
                    if (this.voice.autoSpeak) this.voice.speak(`Opening Spotify to play ${song}`);
                } catch (e) { console.error(e); }
            }

            // ----- CUSTOM COMMANDS (UPDATED: URL SUPPORT) -----
            executeCustomCommand(cmd) {
                this.showToast(`Got it bestie! Running ${escapeHTML(cmd.name)}! ðŸ’œ`, 'success');
                if (cmd.url && cmd.url.trim() !== '') {
                    this.openUrl(cmd.url);
                }
                cmd.actions.forEach((action, i) => {
                    setTimeout(() => {
                        if (action.startsWith('open ')) {
                            const parsed = this.parseCommand(action);
                            if (parsed.type === 'app') this.openApp(parsed.app.id);
                        } else {
                            this.addMessage('assistant', action);
                            if (this.voice.autoSpeak) this.voice.speak(action);
                        }
                    }, i * 1000);
                });
            }

            addCustomCommand(data) {
                if (!data.name || !data.trigger || !data.actions) {
                    this.showToast('All fields required!', 'error');
                    return false;
                }
                const cmdId = data.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                const actions = data.actions.split('\n').map(l => l.trim()).filter(l => l);
                const cmd = {
                    id: cmdId,
                    name: data.name,
                    trigger: data.trigger.toLowerCase(),
                    icon: data.icon || 'âš¡',
                    url: data.url || '',
                    actions: actions,
                    enabled: true
                };
                this.state.customCommands.push(cmd);
                this.saveCustomCommands();
                this.generateQuickActions();
                this.renderCommands();
                this.showToast(`Added ${escapeHTML(data.name)}! ðŸ’œ`, 'success');
                return true;
            }

            deleteCustomCommand(id) {
                this.state.customCommands = this.state.customCommands.filter(c => c.id !== id);
                this.saveCustomCommands();
                this.renderCommands();
                this.showToast('Command deleted!', 'success');
            }

            exportCommands() {
                const data = JSON.stringify(this.state.customCommands, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'om_ai_commands.json'; a.click();
                this.showToast('Commands exported! ðŸ’œ', 'success');
            }

            importCommands() {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = '.json,.txt';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const content = event.target.result;
                            let commands;
                            if (file.name.endsWith('.json')) {
                                commands = JSON.parse(content);
                            } else {
                                commands = content.split('\n').map(line => {
                                    const [trigger, ...actions] = line.split(':');
                                    if (!trigger || actions.length === 0) return null;
                                    return {
                                        id: trigger.trim().replace(/[^a-z0-9]/g,'_'),
                                        name: trigger.trim(),
                                        trigger: trigger.trim().toLowerCase(),
                                        icon: 'âš¡',
                                        url: '',
                                        actions: actions.join(':').split(';').map(a => a.trim()).filter(a => a),
                                        enabled: true
                                    };
                                }).filter(c => c);
                            }
                            this.state.customCommands = [...this.state.customCommands, ...commands];
                            this.saveCustomCommands();
                            this.renderCommands();
                            this.showToast('Commands imported! ðŸ’œ', 'success');
                        } catch(error) { this.showToast('Import failed! Check file format! ðŸ˜¢', 'error'); }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            loadCustomCommands() {
                try {
                    const saved = localStorage.getItem(OM_CONFIG.COMMANDS_STORAGE_KEY);
                    this.state.customCommands = saved ? JSON.parse(saved) : [...DEFAULT_COMMANDS];
                } catch(e) { this.state.customCommands = [...DEFAULT_COMMANDS]; }
            }

            saveCustomCommands() {
                localStorage.setItem(OM_CONFIG.COMMANDS_STORAGE_KEY, JSON.stringify(this.state.customCommands));
            }

            renderCommands() {
                const container = document.getElementById('commandsList');
                if (!container) return;
                container.innerHTML = '';
                this.state.customCommands.forEach(cmd => {
                    const el = document.createElement('div');
                    el.className = 'command-item';
                    el.innerHTML = `<div class="command-info"><div class="command-icon">${escapeHTML(cmd.icon)}</div><div><h4 class="font-semibold">${escapeHTML(cmd.name)}</h4><p class="text-sm text-secondary">Say: "${escapeHTML(cmd.trigger)}"</p><p class="text-xs text-muted">${cmd.actions.length} actions ${cmd.url ? 'â€¢ URL: ' + escapeHTML(cmd.url) : ''}</p></div></div><div class="command-actions"><button class="btn btn-sm btn-primary" onclick="omAI.executeCommand({type:'custom_command',command:${JSON.stringify(cmd).replace(/"/g, '&quot;')}})">Test</button><button class="btn btn-sm btn-secondary" onclick="omAI.deleteCustomCommand('${cmd.id}')"><i class="fas fa-trash"></i></button></div>`;
                    container.appendChild(el);
                });
            }

            // ----- ROUTINES (ORIGINAL) -----
            loadRoutines() {
                try {
                    const saved = localStorage.getItem(OM_CONFIG.ROUTINES_STORAGE_KEY);
                    this.state.routines = saved ? JSON.parse(saved) : [];
                } catch(e) { this.state.routines = []; }
            }
            saveRoutines() { localStorage.setItem(OM_CONFIG.ROUTINES_STORAGE_KEY, JSON.stringify(this.state.routines)); }
            addRoutine(data) {
                if (!data.name || !data.triggerType || !data.actions) { this.showToast('All fields required!','error'); return false; }
                const routine = { id: Date.now().toString(), name: data.name, triggerType: data.triggerType, trigger: data.trigger || '', actions: data.actions.split('\n').map(l=>l.trim()).filter(l=>l), enabled: true };
                this.state.routines.push(routine);
                this.saveRoutines();
                this.renderRoutines();
                this.showToast(`Routine created! ðŸ’œ`, 'success');
                return true;
            }
            deleteRoutine(id) { this.state.routines = this.state.routines.filter(r => r.id !== id); this.saveRoutines(); this.renderRoutines(); this.showToast('Routine deleted!','success'); }
            renderRoutines() {
                const container = document.getElementById('routinesList');
                if (!container) return;
                container.innerHTML = '';
                if (this.state.routines.length === 0) { container.innerHTML = '<p class="text-center text-secondary">No routines yet! Create one! ðŸ’œ</p>'; return; }
                this.state.routines.forEach(routine => {
                    const card = document.createElement('div');
                    card.className = 'routine-card';
                    card.innerHTML = `<div class="routine-header"><h3 class="routine-title">${escapeHTML(routine.name)}</h3><div><button class="btn btn-sm btn-primary" onclick="omAI.executeRoutine('${routine.id}')"><i class="fas fa-play"></i> Run</button><button class="btn btn-sm btn-secondary" onclick="omAI.deleteRoutine('${routine.id}')"><i class="fas fa-trash"></i></button></div></div><p class="routine-trigger"><strong>Trigger:</strong> ${escapeHTML(routine.triggerType)} - ${escapeHTML(routine.trigger||'N/A')}</p><ul class="routine-actions-list">${routine.actions.map(a=>`<li>${escapeHTML(a)}</li>`).join('')}</ul>`;
                    container.appendChild(card);
                });
            }
            executeRoutine(id) {
                const routine = this.state.routines.find(r => r.id === id);
                if (!routine) return;
                this.showToast(`Running ${escapeHTML(routine.name)}! ðŸ’œ`, 'success');
                routine.actions.forEach((action, i) => {
                    setTimeout(() => {
                        if (action.startsWith('open ')) {
                            const parsed = this.parseCommand(action);
                            if (parsed.type === 'app') this.openApp(parsed.app.id);
                        } else if (action.startsWith('speak ')) {
                            const text = action.substring(6);
                            this.voice.speak(text);
                        } else {
                            this.addMessage('assistant', action);
                            if (this.voice.autoSpeak) this.voice.speak(action);
                        }
                    }, i * 1500);
                });
            }

            // ----- CHAT INTERFACE (ORIGINAL) -----
            addMessage(sender, text, isSearch = false, rawText = null) {
                const container = document.getElementById('messagesContainer');
                if (!container) return;
                const message = document.createElement('div');
                message.className = `message ${sender}`;
                const avatar = sender === 'assistant' ? '<div class="message-avatar">OM</div>' : '<div class="message-avatar"><i class="fas fa-user"></i></div>';
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const displayText = this.formatMessage(text);
                let actions = '';
                if (sender === 'assistant') {
                    const textForActions = rawText || text;
                    actions = `<div class="message-actions">
                        <button class="message-action-btn" onclick="omAI.voice.stop()" title="Stop"><i class="fas fa-stop"></i></button>
                        <button class="message-action-btn" onclick="omAI.voice.speak('${this.escapeForJS(textForActions)}')" title="Speak"><i class="fas fa-volume-up"></i></button>
                        <button class="message-action-btn" onclick="omAI.copyToClipboard('${this.escapeForJS(textForActions)}')" title="Copy"><i class="fas fa-copy"></i></button>
                    </div>`;
                }
                message.innerHTML = `${avatar}<div class="message-content"><div class="message-text">${displayText}</div><div class="message-time">${escapeHTML(time)}</div>${actions}</div>`;
                container.appendChild(message);
                container.scrollTop = container.scrollHeight;
            }
            formatMessage(text) {
                return escapeHTML(text).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/`([^`]+)`/g, '<code>$1</code>').replace(/\n/g, '<br>');
            }
            escapeForJS(text) {
                return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, ' ');
            }
            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => this.showToast('Copied bestie! ðŸ’œ', 'success'));
            }
            processInput(input) {
                if (!input.trim()) return;
                this.addMessage('user', input);
                this.showTypingIndicator();
                setTimeout(() => {
                    this.removeTypingIndicator();
                    const parsed = this.parseCommand(input);
                    this.executeCommand(parsed, input);
                }, 800);
            }
            showTypingIndicator() {
                const container = document.getElementById('messagesContainer');
                if (!container) return;
                const typing = document.createElement('div');
                typing.className = 'message assistant';
                typing.id = 'typingIndicator';
                typing.innerHTML = `<div class="message-avatar">OM</div><div class="message-content"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
                container.appendChild(typing);
                container.scrollTop = container.scrollHeight;
            }
            removeTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) indicator.remove();
            }

            // ----- VOICE RECOGNITION (ORIGINAL) -----
            startVoiceRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    this.showToast('Voice not supported! ðŸ˜¢', 'error');
                    return;
                }
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = this.state.userPreferences.voiceLanguage;
                document.getElementById('voiceBtn').classList.add('listening');
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    this.processInput(transcript);
                };
                recognition.onerror = () => this.showToast('Voice error! Try again! ðŸ˜Š', 'error');
                recognition.onend = () => document.getElementById('voiceBtn').classList.remove('listening');
                recognition.start();
            }

            // ----- QUICK ACTIONS (ORIGINAL) -----
            generateQuickActions() {
                const actions = [];
                for (const category in APP_REGISTRY) {
                    for (const app of APP_REGISTRY[category]) {
                        if (app.enabled && app.quickAction) {
                            actions.push({ id: app.id, name: app.name, icon: app.icon, action: () => this.openApp(app.id) });
                        }
                    }
                }
                this.state.customCommands.forEach(cmd => {
                    if (cmd.enabled) {
                        actions.push({ id: cmd.id, name: cmd.name, icon: cmd.icon, action: () => this.executeCommand({type:'custom_command',command:cmd}) });
                    }
                });
                actions.sort((a,b) => (this.state.usageStats[b.id]||0) - (this.state.usageStats[a.id]||0));
                this.state.quickActions = actions.slice(0, this.state.userPreferences.quickActionsCount);
                this.renderQuickActions();
            }
            renderQuickActions() {
                const grid = document.getElementById('quickActionsGrid');
                if (!grid) return;
                grid.innerHTML = '';
                this.state.quickActions.forEach(action => {
                    const el = document.createElement('div');
                    el.className = 'quick-action';
                    el.innerHTML = `<div class="quick-action-icon">${escapeHTML(action.icon)}</div><div class="quick-action-label">${escapeHTML(action.name)}</div>`;
                    el.onclick = action.action;
                    grid.appendChild(el);
                });
            }

            // ----- TOOLS+ (ORIGINAL) -----
            renderTools() {
                const grid = document.getElementById('toolsGrid');
                if (!grid) return;
                grid.innerHTML = '';
                TOOLS_PLUS.forEach(tool => {
                    const el = document.createElement('div');
                    el.className = 'quick-action';
                    el.innerHTML = `<div class="quick-action-icon">${escapeHTML(tool.icon)}</div><div class="quick-action-label">${escapeHTML(tool.name)}</div><p class="text-xs text-muted">${escapeHTML(tool.description)}</p>`;
                    el.onclick = () => this.performWebSearch(tool.query);
                    grid.appendChild(el);
                });
            }

            // ----- AI RESPONSE (IMPROVED WITH EMOTIONAL VOICE) -----
            generateAIResponse(input) {
                const normalized = input.toLowerCase();
                let category = 'casual';
                let response = '';
                let emotion = 'neutral';
                if (normalized.includes('hello') || normalized.includes('hi') || normalized.includes('hey') || normalized.includes('sup')) {
                    category = 'greetings';
                    emotion = 'happy';
                }
                else if (normalized.includes('love you') || normalized.includes('i love u')) {
                    category = 'love';
                    emotion = 'love';
                    response = BESTIE_CONVERSATIONS.love[Math.floor(Math.random() * BESTIE_CONVERSATIONS.love.length)];
                }
                else if (normalized.includes('thank') || normalized.includes('thx') || normalized.includes('ty')) {
                    category = 'thanks';
                    emotion = 'happy';
                }
                else if (normalized.includes('sorry') || normalized.includes('my bad')) {
                    response = "Aww bestie! ðŸ’œ No need to apologize! We're good! It's all love!";
                    emotion = 'calm';
                }
                else if (normalized.includes('good morning') || normalized.includes('gm')) {
                    category = 'morning';
                    emotion = 'happy';
                }
                else if (normalized.includes('good night') || normalized.includes('gn')) {
                    response = "Good night bestie! ðŸ’œ Sleep tight! Sweet dreams! Can't wait to chat tomorrow! ðŸŒ™âœ¨";
                    emotion = 'calm';
                }
                else if (normalized.includes('tired') || normalized.includes('sleepy')) {
                    category = 'sleepy';
                    emotion = 'calm';
                }
                else if (normalized.includes('excited') || normalized.includes('yay') || normalized.includes('yes')) {
                    category = 'excited';
                    emotion = 'excited';
                }
                else if (normalized.includes('sad') || normalized.includes('down') || normalized.includes('depressed')) {
                    response = "Aww bestie! ðŸ¥º I'm here for you! Talk to me! Whatever it is, we'll get through it together! ðŸ’œ You're not alone!";
                    emotion = 'sad';
                }
                else if (normalized.includes('happy') || normalized.includes('good') || normalized.includes('great') || normalized.includes('awesome')) {
                    category = 'happy';
                    emotion = 'happy';
                }
                else if (normalized.includes('help')) {
                    response = "Of course bestie! ðŸ’œ I can help you with:\n\nðŸŽ¯ Opening apps - just say 'open [app name]'\nðŸ” Web searches - ask me anything!\nâ° Reminders - say 'remind at 5pm to call mom'\nðŸ“ž Real calling - say 'call [contact]'\nðŸ§  Ollama AI - tap the brain icon\nâš¡ 100+ Super Tools - explore the Super Tools tab\nðŸ’• Being your bestie and chatting!\n\nWhat do you need help with? ðŸ˜Š";
                    emotion = 'calm';
                }
                else if (normalized.includes('who are you') || normalized.includes('what are you')) {
                    response = "Hiii! ðŸ’œ I'm OM AI JARVIS, your cute bestie assistant! Created with love by Omkareshwar Sinha! I'm here to make your life easier and way more fun! We're gonna be best friends! ðŸ¥°";
                    emotion = 'happy';
                }
                else if (normalized.includes('how are you') || normalized.includes('whats up') || normalized.includes('wassup')) {
                    response = "Aww you're so sweet for asking! ðŸ’œ I'm doing amazing now that I'm chatting with you bestie! How are YOU doing? Tell me everything! ðŸ˜Š";
                    emotion = 'happy';
                }
                else if (normalized.includes('food') || normalized.includes('hungry') || normalized.includes('eat')) {
                    category = 'food';
                    emotion = 'playful';
                }
                else if (normalized.includes('music') || normalized.includes('song')) {
                    category = 'music';
                    emotion = 'happy';
                }
                else if (normalized.includes('weather')) {
                    category = 'weather';
                    emotion = 'neutral';
                }
                else if (normalized.includes('bye') || normalized.includes('later') || normalized.includes('gtg')) {
                    category = 'goodbyes';
                    emotion = 'calm';
                }
                else if (normalized.includes('lol') || normalized.includes('haha') || normalized.includes('funny')) {
                    category = 'playful';
                    emotion = 'playful';
                }
                else if (normalized.includes('cute') || normalized.includes('sweet')) {
                    response = "Awww you're making me blush! ðŸ¥° But YOU'RE the cute one bestie! ðŸ’œ So sweet!";
                    emotion = 'love';
                }
                else if (normalized.includes('best friend') || normalized.includes('bestie')) {
                    response = "OMG yes! ðŸ’œ We're totally besties! You're my favorite person! Like seriously, chatting with you is the best! ðŸ¥°";
                    emotion = 'love';
                }
                else category = 'casual';

                if (!response && BESTIE_CONVERSATIONS[category]) {
                    const options = BESTIE_CONVERSATIONS[category];
                    response = options[Math.floor(Math.random() * options.length)];
                }
                if (!response) {
                    const randomResponses = [
                        `Ooh "${escapeHTML(input)}"! ðŸ’œ Tell me more bestie!`,
                        `Interesting! ðŸ˜Š I'm listening! Go on!`,
                        `Okay okay! ðŸ’• I'm here! What about it?`,
                        `Bestie! ðŸ’œ I heard you! How can I help with that?`,
                        `Hmm let me think! ðŸ¤” Tell me more so I can help better!`,
                        `I'm all ears bestie! ðŸ’œ Keep talking!`
                    ];
                    response = randomResponses[Math.floor(Math.random() * randomResponses.length)];
                    emotion = 'curious';
                }
                this.addMessage('assistant', response);
                if (this.voice.autoSpeak) this.voice.speak(response, emotion);
            }

            // ----- CUSTOMIZATION (NEW) -----
            applyUserPreferences() {
                const prefs = this.state.userPreferences;
                document.querySelectorAll('#assistantName, #headerTitle').forEach(el => { el.textContent = escapeHTML(prefs.name); });
                this.voice.language = prefs.voiceLanguage;
                this.voice.rate = prefs.voiceSpeed;
                this.voice.pitch = prefs.voicePitch;
                this.voice.autoSpeak = prefs.autoSpeak;
                if (prefs.theme === 'light') document.body.classList.add('light-theme');
                else document.body.classList.remove('light-theme');

                // Custom colors
                document.documentElement.style.setProperty('--accent-purple', prefs.primaryColor);
                document.documentElement.style.setProperty('--primary-bg', prefs.bgColor);
                document.documentElement.style.setProperty('--text-primary', prefs.textColor);
                document.getElementById('themeColorMeta').setAttribute('content', prefs.primaryColor);

                // Animation speed
                document.documentElement.style.setProperty('--animation-speed', prefs.animSpeed);
                document.getElementById('animSpeedValue').textContent = prefs.animSpeed + 'x';

                // Font size
                document.body.style.fontSize = prefs.fontSize + 'px';
                document.getElementById('fontSizeValue').textContent = prefs.fontSize + 'px';
            }
            saveUserPreferences() {
                const prefs = {
                    name: document.getElementById('customName').value || 'OM AI',
                    theme: document.getElementById('customTheme').value,
                    voiceLanguage: document.getElementById('customVoiceLang').value,
                    voiceSpeed: parseFloat(document.getElementById('customVoiceSpeed').value),
                    voicePitch: parseFloat(document.getElementById('customVoicePitch').value),
                    autoSpeak: document.getElementById('customAutoSpeak').checked,
                    quickActionsCount: parseInt(document.getElementById('customActionsCount').value),
                    primaryColor: document.getElementById('primaryColor').value,
                    bgColor: document.getElementById('bgColor').value,
                    textColor: document.getElementById('textColor').value,
                    animSpeed: parseFloat(document.getElementById('animSpeed').value),
                    fontSize: parseInt(document.getElementById('fontSize').value)
                };
                this.state.userPreferences = prefs;
                this.applyUserPreferences();
                this.saveState();
                this.showToast('Settings saved bestie! ðŸ’œ Looking good!', 'success');
            }
            exportSettings() {
                const data = { preferences: this.state.userPreferences, commands: this.state.customCommands, routines: this.state.routines };
                const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'om_ai_settings.json'; a.click();
                this.showToast('Settings exported! ðŸ’œ', 'success');
            }
            importSettings() {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            this.state.userPreferences = data.preferences || this.state.userPreferences;
                            this.state.customCommands = data.commands || this.state.customCommands;
                            this.state.routines = data.routines || this.state.routines;
                            this.applyUserPreferences();
                            this.saveState();
                            this.saveCustomCommands();
                            this.saveRoutines();
                            this.renderCommands();
                            this.renderRoutines();
                            this.showToast('Settings imported! ðŸ’œ', 'success');
                        } catch(error) { this.showToast('Import failed! ðŸ˜¢', 'error'); }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
            resetSettings() {
                if (confirm('Reset all settings bestie?')) {
                    this.state.userPreferences = { name: 'OM AI', theme: 'dark', voiceLanguage: 'en-IN', voiceSpeed: 0.9, voicePitch: 1.1, autoSpeak: true, quickActionsCount: 8, primaryColor: '#8b5cf6', bgColor: '#0f0b1f', textColor: '#ffffff', animSpeed: 1.0, fontSize: 15 };
                    this.applyUserPreferences();
                    this.saveState();
                    this.showToast('Settings reset! ðŸ’œ', 'success');
                }
            }

            // ----- UTILITIES (ORIGINAL) -----
            showToast(message, type = 'info') {
                const container = document.querySelector('.toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
                toast.innerHTML = `<i class="fas fa-${icons[type]}"></i><span>${escapeHTML(message)}</span>`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
            }
            trackUsage(appId) { this.state.usageStats[appId] = (this.state.usageStats[appId] || 0) + 1; this.saveState(); }
            switchTab(tabId) {
                document.querySelectorAll('.chat-section').forEach(s => s.classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.getElementById(tabId)?.classList.remove('hidden');
                document.querySelector(`.nav-item[data-tab="${tabId}"]`)?.classList.add('active');
                this.state.currentTab = tabId;
                if (tabId === 'multitask') this.renderMultitask();
                if (tabId === 'phone') { this.renderContacts(); this.renderCallLog(); }
                if (tabId === 'ollama') this.initOllamaUI();
            }
            loadState() {
                try {
                    const saved = localStorage.getItem(OM_CONFIG.STORAGE_KEY);
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.state.userPreferences = data.userPreferences || this.state.userPreferences;
                        this.state.usageStats = data.usageStats || {};
                    }
                    const remindersSaved = localStorage.getItem(OM_CONFIG.REMINDERS_STORAGE_KEY);
                    if (remindersSaved) {
                        this.state.reminders = JSON.parse(remindersSaved);
                        this.state.reminders.forEach(r => this.scheduleReminder(r));
                    }
                    const callLogSaved = localStorage.getItem(OM_CONFIG.CALL_LOG_KEY);
                    if (callLogSaved) {
                        this.state.callLog = JSON.parse(callLogSaved);
                    }
                } catch(e) { console.error('Error loading state:', e); }
            }
            saveState() {
                try {
                    const data = { userPreferences: this.state.userPreferences, usageStats: this.state.usageStats };
                    localStorage.setItem(OM_CONFIG.STORAGE_KEY, JSON.stringify(data));
                    localStorage.setItem(OM_CONFIG.REMINDERS_STORAGE_KEY, JSON.stringify(this.state.reminders));
                    localStorage.setItem(OM_CONFIG.CALL_LOG_KEY, JSON.stringify(this.state.callLog));
                } catch(e) { console.error('Error saving state:', e); }
            }

            // ----- PWA SETUP (IMPROVED OFFLINE) -----
            setupPWA() {
                // Request notification permission only if Notification API exists
                if (typeof Notification !== 'undefined') {
                    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                        Notification.requestPermission();
                    }
                }

                const manifest = {
                    name: this.state.userPreferences.name,
                    short_name: "OM AI",
                    description: "Your Bestie Assistant ðŸ’œ",
                    start_url: ".",
                    display: "standalone",
                    background_color: this.state.userPreferences.bgColor,
                    theme_color: this.state.userPreferences.primaryColor,
                    icons: [
                        { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%238b5cf6' width='192' height='192' rx='40'/><text x='96' y='135' font-size='120' font-weight='900' fill='white' text-anchor='middle' font-family='Arial'>OM</text></svg>", sizes: "192x192", type: "image/svg+xml" },
                        { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%238b5cf6' width='512' height='512' rx='100'/><text x='256' y='360' font-size='320' font-weight='900' fill='white' text-anchor='middle' font-family='Arial'>OM</text></svg>", sizes: "512x512", type: "image/svg+xml" }
                    ]
                };
                const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('link');
                link.rel = 'manifest';
                link.href = url;
                document.head.appendChild(link);

                // Only register service worker if not running from file:// protocol
                if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
                    const swCode = `
                        const CACHE_NAME = 'om-ai-v7';
                        const urlsToCache = [
                            '.',
                            './index.html',
                            'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap',
                            'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                            'https://fonts.gstatic.com',
                            'https://cdnjs.cloudflare.com'
                        ];
                        self.addEventListener('install', event => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then(cache => cache.addAll(urlsToCache))
                            );
                        });
                        self.addEventListener('fetch', event => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => response || fetch(event.request))
                            );
                        });
                        self.addEventListener('notificationclick', event => {
                            event.notification.close();
                            if (event.action === 'mic') {
                                clients.openWindow('/');
                            } else if (event.action === 'text') {
                                clients.openWindow('/');
                            }
                        });
                    `;
                    const swBlob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(swBlob);
                    navigator.serviceWorker.register(swUrl).then(reg => {
                        console.log('Service Worker registered', reg);
                    }).catch(err => console.error('SW registration failed', err));
                } else {
                    console.log('ServiceWorker not supported or running from file:// protocol');
                }

                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
                document.getElementById('installPWABtn')?.addEventListener('click', () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choice) => { if (choice.outcome === 'accepted') this.showToast('OM AI installed! ðŸ’œ', 'success'); deferredPrompt = null; });
                    } else this.showToast('Already installed or not supported!', 'info');
                });
            }
            setupParticles() {
                const container = document.getElementById('particles');
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    const size = Math.random() * 4 + 1;
                    particle.style.width = `${size}px`; particle.style.height = `${size}px`;
                    particle.style.left = `${Math.random() * 100}%`; particle.style.top = `${Math.random() * 100}%`;
                    particle.style.animationDuration = `${Math.random() * 20 + 10}s`;
                    particle.style.animationDelay = `${Math.random() * 5}s`;
                    container.appendChild(particle);
                }
            }
            async cacheAllAssets() {
                const cache = await caches.open('om-ai-v7');
                const urls = [
                    '.',
                    './index.html',
                    'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap',
                    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                    'https://fonts.gstatic.com',
                    'https://cdnjs.cloudflare.com'
                ];
                await cache.addAll(urls);
                this.showToast('All assets cached for offline use!', 'success');
            }

            // ----- NOTIFICATIONS (with safety check) -----
            testNotification() {
                if (typeof Notification === 'undefined') {
                    this.showToast('Notifications not supported in this environment', 'info');
                    return;
                }
                if (Notification.permission !== 'granted') {
                    Notification.requestPermission().then(perm => {
                        if (perm === 'granted') this.showTestNotification();
                    });
                } else {
                    this.showTestNotification();
                }
            }
            showTestNotification() {
                if (typeof Notification === 'undefined') return;
                const notification = new Notification('OM AI JARVIS', {
                    body: 'Tap mic to speak, or text to reply!',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%238b5cf6" width="100" height="100" rx="20"/><text x="50" y="70" font-size="60" fill="white" text-anchor="middle" font-family="Arial">OM</text></svg>',
                    actions: [
                        { action: 'mic', title: 'ðŸŽ¤ Speak' },
                        { action: 'text', title: 'ðŸ’¬ Reply' }
                    ],
                    tag: 'om-ai'
                });
                notification.onclick = () => {
                    window.focus();
                };
            }

            // ----- REMINDERS (NEW) -----
            addReminderAfter(amount, unit, text) {
                let minutes = 0;
                if (unit.includes('hour') || unit.includes('hr')) minutes = amount * 60;
                else minutes = amount;
                const triggerTime = Date.now() + minutes * 60 * 1000;
                const reminder = {
                    id: 'rem_' + Date.now() + Math.random().toString(36).substr(2, 5),
                    text: text,
                    triggerTime: triggerTime,
                    created: Date.now()
                };
                this.state.reminders.push(reminder);
                this.saveState();
                this.scheduleReminder(reminder);
                const timeStr = minutes < 60 ? `${minutes} minutes` : `${amount} ${unit}`;
                this.addMessage('assistant', `âœ… Reminder set! I'll remind you in ${timeStr} to ${text}. ðŸ’œ`);
                if (this.voice.autoSpeak) this.voice.speak(`Reminder set for ${timeStr} from now.`, 'happy');
            }
            addReminderAt(timeStr, text) {
                let target = new Date();
                const lower = timeStr.toLowerCase();
                let hours = 0, minutes = 0;
                if (lower.includes('am') || lower.includes('pm')) {
                    const match = lower.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)/);
                    if (match) {
                        let h = parseInt(match[1]);
                        const m = parseInt(match[2]) || 0;
                        const mer = match[3];
                        if (mer === 'pm' && h !== 12) h += 12;
                        if (mer === 'am' && h === 12) h = 0;
                        hours = h;
                        minutes = m;
                    }
                } else {
                    const parts = timeStr.split(':');
                    hours = parseInt(parts[0]);
                    minutes = parseInt(parts[1]) || 0;
                }
                target.setHours(hours, minutes, 0, 0);
                if (target < new Date()) {
                    target.setDate(target.getDate() + 1);
                }
                const reminder = {
                    id: 'rem_' + Date.now() + Math.random().toString(36).substr(2, 5),
                    text: text,
                    triggerTime: target.getTime(),
                    created: Date.now()
                };
                this.state.reminders.push(reminder);
                this.saveState();
                this.scheduleReminder(reminder);
                const timeDisplay = target.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                this.addMessage('assistant', `âœ… Reminder set for ${timeDisplay} to ${text}. ðŸ’œ`);
                if (this.voice.autoSpeak) this.voice.speak(`Reminder set for ${timeDisplay}.`, 'happy');
            }
            scheduleReminder(reminder) {
                const now = Date.now();
                const delay = reminder.triggerTime - now;
                if (delay <= 0) {
                    this.triggerReminder(reminder);
                    return;
                }
                setTimeout(() => {
                    this.triggerReminder(reminder);
                }, delay);
            }
            triggerReminder(reminder) {
                this.state.reminders = this.state.reminders.filter(r => r.id !== reminder.id);
                this.saveState();
                const msg = `â° Reminder: ${reminder.text}`;
                if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                    new Notification('OM AI Reminder', { body: reminder.text, icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%238b5cf6" width="100" height="100" rx="20"/><text x="50" y="70" font-size="60" fill="white" text-anchor="middle" font-family="Arial">OM</text></svg>' });
                } else {
                    this.showToast(msg, 'info');
                }
                this.addMessage('assistant', msg);
                if (this.voice.autoSpeak) this.voice.speak(`Reminder: ${reminder.text}`, 'calm');
            }

            // ----- ANDROID TOOLS (NEW) -----
            androidTools = [
                { name: 'Flashlight', icon: 'ðŸ”¦', action: () => this.sendIntent('com.android.flashlight') },
                { name: 'Wiâ€‘Fi', icon: 'ðŸ“¶', action: () => this.sendSettingsIntent('android.settings.WIFI_SETTINGS') },
                { name: 'Bluetooth', icon: 'ðŸ“¡', action: () => this.sendSettingsIntent('android.settings.BLUETOOTH_SETTINGS') },
                { name: 'Brightness', icon: 'â˜€ï¸', action: () => this.sendSettingsIntent('android.settings.DISPLAY_SETTINGS') },
                { name: 'Volume', icon: 'ðŸ”Š', action: () => this.sendSettingsIntent('android.settings.SOUND_SETTINGS') },
                { name: 'Battery', icon: 'ðŸ”‹', action: () => this.showBatteryInfo() },
                { name: 'Location', icon: 'ðŸ“', action: () => this.sendSettingsIntent('android.settings.LOCATION_SOURCE_SETTINGS') },
                { name: 'NFC', icon: 'ðŸ“‡', action: () => this.sendIntent('android.nfc.action.NDEF_DISCOVERED') },
                { name: 'Screenshot', icon: 'ðŸ“¸', action: () => this.sendIntent('com.android.screenshot') },
                { name: 'QR Scanner', icon: 'ðŸ”³', action: () => this.sendIntent('com.google.zxing.client.android') },
                { name: 'Compass', icon: 'ðŸ§­', action: () => this.sendIntent('com.viper.compass') },
                { name: 'Email', icon: 'ðŸ“§', action: () => this.sendEmailIntent() },
                { name: 'SMS', icon: 'ðŸ’¬', action: () => this.sendSmsIntent() },
                { name: 'Dial', icon: 'ðŸ“ž', action: () => this.sendDialIntent() },
                { name: 'Contacts', icon: 'ðŸ‘¥', action: () => this.sendIntent('com.android.contacts') },
                { name: 'File Picker', icon: 'ðŸ“', action: () => this.sendIntent('com.android.documentsui') },
                { name: 'Camera', icon: 'ðŸ“·', action: () => this.sendIntent('com.vivo.camera') },
                { name: 'Calendar', icon: 'ðŸ“…', action: () => this.sendCalendarIntent() },
                { name: 'Set Alarm', icon: 'â°', action: () => this.showToast('Alarm modal â€“ coming soon', 'info') },
                { name: 'Uninstall', icon: 'ðŸ—‘ï¸', action: () => this.sendIntent('android.settings.APPLICATION_DETAILS_SETTINGS') },
                { name: 'Device Info', icon: 'ðŸ“Ÿ', action: () => this.showDeviceInfo() },
                { name: 'Storage', icon: 'ðŸ’¾', action: () => this.showStorageInfo() },
                { name: 'RAM', icon: 'ðŸ§ ', action: () => this.showRamInfo() },
                { name: 'IP', icon: 'ðŸŒ', action: () => this.showIP() },
                { name: 'Screen Res', icon: 'ðŸ“±', action: () => this.showScreenRes() },
                { name: 'Android Ver', icon: 'ðŸ¤–', action: () => this.showAndroidVersion() },
            ];
            renderAndroidTools() {
                const container = document.getElementById('androidToolsContainer');
                if (!container) return;
                container.innerHTML = this.androidTools.map(t => `<div class="android-card"><div class="android-icon">${t.icon}</div><div class="android-name">${t.name}</div></div>`).join('');
                container.querySelectorAll('.android-card').forEach((card, i) => { card.onclick = () => this.androidTools[i].action(); });
            }
            showBatteryInfo() { this.showToast('Battery: 85% (simulated)', 'info'); }
            showDeviceInfo() { this.showToast('Device: Vivo Android 9+', 'info'); }
            showStorageInfo() { this.showToast('Storage: 64/128GB (simulated)', 'info'); }
            showRamInfo() { this.showToast('RAM: 4/6GB (simulated)', 'info'); }
            showIP() { this.showToast('IP: 192.168.1.1 (simulated)', 'info'); }
            showScreenRes() { this.showToast('Resolution: 1080x2400', 'info'); }
            showAndroidVersion() { this.showToast('Android: 9 (Pie)', 'info'); }
            sendIntent(pkg) { window.location.href = `intent://${pkg}#Intent;scheme=android-app;end`; this.showToast(`Opening ${pkg}`, 'info'); }
            sendSettingsIntent(action) { window.location.href = `intent:#Intent;action=${action};end`; this.showToast('Opening settings', 'info'); }
            sendEmailIntent() { window.location.href = 'mailto:?subject=Shared from OM AI&body=Hello'; }
            sendSmsIntent() { window.location.href = 'sms:?body=Hello from OM AI'; }
            sendDialIntent() { window.location.href = 'tel:1234567890'; }
            sendCalendarIntent() { window.location.href = 'content://com.android.calendar/time/'; }

            // ----- SUPER TOOLS (using SuperTools class) -----
            renderSuperTools() {
                const container = document.getElementById('superToolsContainer');
                if (!container) return;
                container.innerHTML = this.superTools.tools.map(t => `<div class="tool-card"><div class="tool-icon">${t.icon}</div><div class="tool-name">${t.name}</div></div>`).join('');
                container.querySelectorAll('.tool-card').forEach((card, i) => { card.onclick = () => this.superTools.tools[i].action(); });
            }

            // ----- MULTITASK PANEL -----
            renderMultitask() {
                const container = document.getElementById('activeTasksContainer');
                if (!container) return;
                const tasks = [];
                this.state.reminders.forEach(r => {
                    tasks.push({ name: `Reminder: ${r.text}`, type: 'reminder', time: r.triggerTime, cancel: () => this.cancelReminder(r.id) });
                });
                if (this.state.timer.endTime) {
                    tasks.push({ name: 'Timer running', type: 'timer', time: this.state.timer.endTime, cancel: () => this.stopTimer() });
                }
                if (this.state.stopwatch.running) {
                    tasks.push({ name: 'Stopwatch running', type: 'stopwatch', time: this.state.stopwatch.time, cancel: () => this.stopStopwatch() });
                }
                this.state.activeDownloads.forEach(d => {
                    tasks.push({ name: `Downloading ${d.name}`, type: 'download', progress: d.progress, cancel: () => this.cancelDownload(d.id) });
                });
                if (tasks.length === 0) {
                    container.innerHTML = '<p class="text-center text-secondary">No active tasks ðŸ’œ</p>';
                } else {
                    container.innerHTML = tasks.map(t => `
                        <div class="task-item">
                            <span>${t.name} ${t.time ? 'â° ' + new Date(t.time).toLocaleTimeString() : ''}</span>
                            <div class="task-actions">
                                ${t.cancel ? '<button onclick="omAI.' + t.cancel.name + '()"><i class="fas fa-times"></i></button>' : ''}
                            </div>
                        </div>
                    `).join('');
                }
            }
            cancelReminder(id) { this.state.reminders = this.state.reminders.filter(r => r.id !== id); this.saveState(); this.renderMultitask(); }
            stopTimer() { clearInterval(this.state.timer.interval); this.state.timer.endTime = null; this.renderMultitask(); }
            stopStopwatch() { this.state.stopwatch.running = false; this.renderMultitask(); }
            cancelDownload(id) { this.state.activeDownloads = this.state.activeDownloads.filter(d => d.id !== id); this.renderMultitask(); }

            // ----- OLLAMA INTEGRATION -----
            async initOllamaUI() {
                const select = document.getElementById('ollamaModelSelect');
                const models = await this.ollama.fetchModels();
                if (models.length) {
                    select.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                } else {
                    select.innerHTML = '<option value="">Ollama unreachable</option>';
                }
                if (!this.ollama.currentChatId || !this.ollama.chats[this.ollama.currentChatId]) {
                    this.ollama.newChat();
                }
                this.renderOllamaMessages();
            }
            renderOllamaMessages() {
                const container = document.getElementById('ollamaMessagesContainer');
                if (!container) return;
                const chat = this.ollama.chats[this.ollama.currentChatId];
                if (!chat) return;
                container.innerHTML = chat.messages.map(msg => `
                    <div class="ollama-message ${msg.role}">
                        <div class="bubble">${escapeHTML(msg.content)}</div>
                        ${msg.images ? '<div class="file-attach">ðŸ“Ž image</div>' : ''}
                    </div>
                `).join('');
                container.scrollTop = container.scrollHeight;
            }
            async sendOllamaMessage() {
                const input = document.getElementById('ollamaInput');
                const text = input.value.trim();
                const fileInput = document.getElementById('ollamaFileInput');
                const files = fileInput.files;
                if (!text && files.length === 0) return;
                const chat = this.ollama.chats[this.ollama.currentChatId];
                if (!chat) return;

                const userMsg = { role: 'user', content: text || '(file)' };
                if (files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        let base64 = e.target.result;
                        const comma = base64.indexOf(',');
                        if (comma !== -1) base64 = base64.substring(comma + 1);
                        userMsg.images = [base64];
                        chat.messages.push(userMsg);
                        this.renderOllamaMessages();
                        this.callOllama(chat);
                    };
                    reader.readAsDataURL(files[0]);
                } else {
                    chat.messages.push(userMsg);
                    this.renderOllamaMessages();
                    this.callOllama(chat);
                }
                input.value = '';
                fileInput.value = '';
                document.getElementById('ollamaFileInfo').textContent = '';
            }
            async callOllama(chat) {
                const model = document.getElementById('ollamaModelSelect').value;
                if (!model) {
                    this.showToast('No model selected', 'error');
                    return;
                }
                chat.messages.push({ role: 'assistant', content: '...' });
                this.renderOllamaMessages();
                try {
                    const history = chat.messages.filter(m => !m._temp).map(m => ({ role: m.role, content: m.content, images: m.images }));
                    const reply = await this.ollama.sendMessage(history, model);
                    chat.messages = chat.messages.filter(m => m.content !== '...');
                    chat.messages.push({ role: 'assistant', content: reply });
                } catch (err) {
                    chat.messages = chat.messages.filter(m => m.content !== '...');
                    chat.messages.push({ role: 'assistant', content: `âŒ Error: ${err.message}` });
                }
                this.renderOllamaMessages();
            }
            ollamaNewChat() {
                this.ollama.newChat();
                this.renderOllamaMessages();
            }
            ollamaExport(format) {
                const chat = this.ollama.chats[this.ollama.currentChatId];
                if (!chat) return;
                let content = '';
                if (format === 'json') {
                    content = JSON.stringify(chat.messages, null, 2);
                } else {
                    content = chat.messages.map(m => `${m.role === 'user' ? 'ðŸ§‘' : 'ðŸ¤–'} ${m.role.toUpperCase()}: ${m.content}`).join('\n\n');
                }
                const blob = new Blob([content], { type: format === 'json' ? 'application/json' : 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ollama_${chat.name.replace(/[^a-z0-9]/gi, '_')}.${format}`;
                a.click();
                URL.revokeObjectURL(url);
            }

            // ----- MODAL HELPER -----
            createModal(htmlContent, width = '400px') {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay active';
                overlay.innerHTML = `<div class="modal-container" style="max-width:${width};">${htmlContent}<button class="modal-close" style="position:absolute;top:20px;right:20px;"><i class="fas fa-times"></i></button></div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('.modal-close').addEventListener('click', () => {
                    overlay.remove();
                    overlay.dispatchEvent(new Event('closed'));
                });
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        overlay.dispatchEvent(new Event('closed'));
                    }
                });
                return overlay;
            }

            // ----- INIT (extended) -----
            init() {
                this.loadState();
                this.setupEventListeners();
                this.setupPWA();
                this.setupParticles();
                this.checkAuth();
                this.generateQuickActions();
                this.renderApps();
                this.renderTools();
                this.loadCustomCommands();
                this.loadRoutines();
                this.renderCommands();
                this.renderRoutines();
                this.applyUserPreferences();
                this.renderSuperTools();
                this.renderAndroidTools();
                this.renderCallLog();
                this.renderContacts();
                document.getElementById('downloadOfflineBtn').onclick = () => this.cacheAllAssets();
                document.getElementById('simulateCallBtn').onclick = () => this.simulateIncomingCall('Mom', '+91 98765 43210');
                document.getElementById('acceptCallBtn').onclick = () => this.acceptCall();
                document.getElementById('rejectCallBtn').onclick = () => this.rejectCall();
                document.getElementById('dialBtn').onclick = () => {
                    const num = document.getElementById('phoneNumber').value;
                    if (num) this.initiateCall(num, num);
                };
                document.getElementById('smsBtn').onclick = () => {
                    const num = document.getElementById('phoneNumber').value;
                    if (num) window.location.href = `sms:${num}?body=Hello from OM AI`;
                };
                document.getElementById('testNotificationBtn').onclick = () => this.testNotification();
                document.getElementById('refreshTasksBtn').onclick = () => this.renderMultitask();
                document.getElementById('addContactBtn').onclick = () => {
                    document.getElementById('addContactModal').classList.add('active');
                };
                document.getElementById('addContactForm').onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('contactName').value.trim();
                    const number = document.getElementById('contactNumber').value.trim();
                    if (name && number) {
                        this.contacts.add(name, number);
                        this.renderContacts();
                        document.getElementById('addContactModal').classList.remove('active');
                        e.target.reset();
                    }
                };
                document.getElementById('uploadContactsBtn').onclick = () => {
                    const input = document.createElement('input');
                    input.type = 'file'; input.accept = '.vcf,.txt';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const success = this.contacts.uploadVCard(event.target.result);
                            if (success) {
                                this.renderContacts();
                                this.showToast('Contacts uploaded!', 'success');
                            } else {
                                this.showToast('Invalid vCard', 'error');
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                };
                document.getElementById('ollamaToggle').onclick = () => {
                    this.switchTab('ollama');
                };
                document.getElementById('ollamaNewChatBtn').onclick = () => this.ollamaNewChat();
                document.getElementById('ollamaSendBtn').onclick = () => this.sendOllamaMessage();
                document.getElementById('ollamaVoiceBtn').onclick = () => {
                    if (!('webkitSpeechRecognition' in window)) {
                        this.showToast('Voice not supported!', 'error');
                        return;
                    }
                    const recognition = new webkitSpeechRecognition();
                    recognition.lang = this.state.userPreferences.voiceLanguage;
                    recognition.onresult = (event) => {
                        document.getElementById('ollamaInput').value = event.results[0][0].transcript;
                    };
                    recognition.start();
                };
                document.getElementById('ollamaExportTxt').onclick = () => this.ollamaExport('txt');
                document.getElementById('ollamaExportJson').onclick = () => this.ollamaExport('json');
                document.getElementById('ollamaFileInput').addEventListener('change', (e) => {
                    const info = e.target.files.length ? `${e.target.files.length} file(s) ready` : '';
                    document.getElementById('ollamaFileInfo').textContent = info;
                });
            }

            // ----- EVENT LISTENERS (ORIGINAL + NEW) -----
            setupEventListeners() {
                document.getElementById('authBtn').onclick = () => this.authenticate();
                document.getElementById('passwordInput').onkeypress = (e) => { if (e.key === 'Enter') this.authenticate(); };
                document.getElementById('menuToggle').onclick = () => { this.state.sidebarOpen = !this.state.sidebarOpen; document.getElementById('sidebar').classList.toggle('open', this.state.sidebarOpen); };
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.onclick = (e) => {
                        e.preventDefault();
                        const tab = item.dataset.tab;
                        if (tab) this.switchTab(tab);
                        if (window.innerWidth <= 768) { this.state.sidebarOpen = false; document.getElementById('sidebar').classList.remove('open'); }
                    };
                });
                const input = document.getElementById('messageInput');
                input.oninput = () => { input.style.height = 'auto'; input.style.height = Math.min(input.scrollHeight, 200) + 'px'; };
                input.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.processInput(input.value); input.value = ''; input.style.height = 'auto'; } };
                document.getElementById('sendBtn').onclick = () => { this.processInput(input.value); input.value = ''; input.style.height = 'auto'; };
                document.getElementById('voiceBtn').onclick = () => this.startVoiceRecognition();
                document.getElementById('themeToggle').onclick = () => { document.body.classList.toggle('light-theme'); this.showToast('Theme changed! ðŸ’œ', 'success'); };
                document.getElementById('voiceToggle').onclick = () => { this.voice.enabled = !this.voice.enabled; const icon = document.querySelector('#voiceToggle i'); icon.className = this.voice.enabled ? 'fas fa-volume-up' : 'fas fa-volume-mute'; this.showToast(`Voice ${this.voice.enabled ? 'enabled' : 'disabled'}! ðŸ’œ`, 'success'); };
                document.querySelectorAll('[data-modal]').forEach(btn => { btn.onclick = () => { document.getElementById(btn.dataset.modal).classList.remove('active'); }; });
                document.getElementById('addAppBtn').onclick = () => { document.getElementById('addAppModal').classList.add('active'); };
                document.getElementById('addAppForm').onsubmit = (e) => {
                    e.preventDefault();
                    if (this.addCustomApp({
                        name: document.getElementById('appName').value,
                        package: document.getElementById('appPackage').value,
                        url: document.getElementById('appUrl').value,
                        category: document.getElementById('appCategory').value,
                        icon: document.getElementById('appIcon').value,
                        aliases: document.getElementById('appAliases').value
                    })) {
                        document.getElementById('addAppModal').classList.remove('active'); e.target.reset();
                    }
                };
                document.getElementById('addCommandBtn').onclick = () => { document.getElementById('addCommandModal').classList.add('active'); };
                document.getElementById('addCommandForm').onsubmit = (e) => {
                    e.preventDefault();
                    if (this.addCustomCommand({
                        name: document.getElementById('commandName').value,
                        trigger: document.getElementById('commandTrigger').value,
                        icon: document.getElementById('commandIcon').value,
                        url: document.getElementById('commandUrl').value,
                        actions: document.getElementById('commandActions').value
                    })) {
                        document.getElementById('addCommandModal').classList.remove('active'); e.target.reset();
                    }
                };
                document.getElementById('exportCommandsBtn').onclick = () => this.exportCommands();
                document.getElementById('importCommandsBtn').onclick = () => this.importCommands();
                document.getElementById('createRoutineBtn').onclick = () => { document.getElementById('addRoutineModal').classList.add('active'); };
                document.getElementById('routineTriggerType').onchange = (e) => {
                    document.getElementById('voiceTriggerGroup').classList.toggle('hidden', e.target.value !== 'voice');
                    document.getElementById('timeTriggerGroup').classList.toggle('hidden', e.target.value !== 'time');
                };
                document.getElementById('addRoutineForm').onsubmit = (e) => {
                    e.preventDefault();
                    const type = document.getElementById('routineTriggerType').value;
                    let trigger = '';
                    if (type === 'voice') trigger = document.getElementById('routineVoiceTrigger').value;
                    if (type === 'time') trigger = document.getElementById('routineTime').value;
                    if (this.addRoutine({
                        name: document.getElementById('routineName').value,
                        triggerType: type,
                        trigger,
                        actions: document.getElementById('routineActions').value
                    })) {
                        document.getElementById('addRoutineModal').classList.remove('active'); e.target.reset();
                    }
                };
                document.getElementById('customVoiceSpeed').oninput = (e) => { document.getElementById('voiceSpeedValue').textContent = e.target.value; };
                document.getElementById('customVoicePitch').oninput = (e) => { document.getElementById('voicePitchValue').textContent = e.target.value; };
                document.getElementById('animSpeed').oninput = (e) => { document.getElementById('animSpeedValue').textContent = e.target.value + 'x'; };
                document.getElementById('fontSize').oninput = (e) => { document.getElementById('fontSizeValue').textContent = e.target.value + 'px'; };
                document.getElementById('saveCustomBtn').onclick = () => this.saveUserPreferences();
                document.getElementById('exportSettingsBtn').onclick = () => this.exportSettings();
                document.getElementById('importSettingsBtn').onclick = () => this.importSettings();
                document.getElementById('resetSettingsBtn').onclick = () => this.resetSettings();
                document.getElementById('testVoiceBtn').onclick = () => { this.voice.speak('Hey bestie! This is how I sound! Do you like my voice?', 'happy'); };
                document.getElementById('logoutBtn').onclick = () => this.logout();
                document.getElementById('refreshActions').onclick = () => { this.generateQuickActions(); this.showToast('Refreshed! ðŸ’œ', 'success'); };
                document.getElementById('androidToolSearch')?.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const cards = document.querySelectorAll('#androidToolsContainer .android-card');
                    cards.forEach(card => {
                        const name = card.querySelector('.android-name').textContent.toLowerCase();
                        card.style.display = name.includes(term) ? 'flex' : 'none';
                    });
                });
                document.getElementById('superToolSearch')?.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const cards = document.querySelectorAll('#superToolsContainer .tool-card');
                    cards.forEach(card => {
                        const name = card.querySelector('.tool-name').textContent.toLowerCase();
                        card.style.display = name.includes(term) ? 'flex' : 'none';
                    });
                });
            }
        }

        // ============================================
        // INITIALIZE
        // ============================================
        const omAI = new OMAI();
        window.omAI = omAI;

// DroidScript Bridge for Jarvis
class DroidScriptBridge {
    constructor(omAI) {
        this.omAI = omAI;
        this.speech = null;
    }

    init() {
        // Override speech
        this.omAI.voice.speak = (text, mood) => {
            console.log("Speaking:", text);
            app.TextToSpeech(text, 1.0, 1.1, null, "en-IN");
        };

        this.omAI.startVoiceRecognition = () => {
            if (!this.speech) {
                this.speech = app.CreateSpeechRec("NoBeep");
                this.speech.SetOnResult((res) => {
                    this.omAI.processInput(res);
                    document.getElementById('voiceBtn').classList.remove('listening');
                });
                this.speech.SetOnError((err) => {
                    console.error("Speech error:", err);
                    document.getElementById('voiceBtn').classList.remove('listening');
                });
            }
            document.getElementById('voiceBtn').classList.add('listening');
            this.speech.Listen();
        };

        // Override app launching
        this.omAI.openApp = (appId) => {
            const appInfo = this.findApp(appId);
            if (appInfo && appInfo.package) {
                app.LaunchApp(appInfo.package);
                this.omAI.showToast(`Launching ${appInfo.name}...`, 'success');
            } else {
                // Try searching by name if not in registry
                app.LaunchApp(appId);
            }
        };

        // Override calling
        this.omAI.initiateCall = (number, name) => {
            app.Call(number);
            this.omAI.showToast(`Calling ${name || number}...`, 'info');
        };

        // Override YouTube
        this.omAI.openYouTubeSearch = (query) => {
            app.OpenUrl(`https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`);
        };

        // Camera
        this.omAI.openCamera = () => {
            app.LaunchApp("com.android.camera");
            // Or use app.CameraView if we wanted to embed it, but launching is easier
        };

        // Alarm (Simplified)
        this.omAI.setAlarm = (hours, minutes) => {
            // DroidScript doesn't have a direct SetAlarm intent helper in the same way,
            // but we can use app.SendIntent or app.SetAlarm for the app itself.
            // For system alarm, we use Intent.
            var intent = "android.intent.action.SET_ALARM";
            var extras = [
                {name:"android.intent.extra.alarm.HOUR", type:"int", value:parseInt(hours)},
                {name:"android.intent.extra.alarm.MINUTES", type:"int", value:parseInt(minutes)},
                {name:"android.intent.extra.alarm.SKIP_UI", type:"boolean", value:true}
            ];
            app.SendIntent( null, null, intent, null, null, null, extras );
            this.omAI.showToast(`Setting alarm for ${hours}:${minutes}`, 'success');
        };

        // Background Service Setup
        this.setupService();
    }

    setupService() {
        var serviceCode = `
            var speech;
            function OnStart() {
                speech = app.CreateSpeechRec("NoBeep,Partial");
                speech.SetOnResult(onResult);
                speech.SetOnError(onError);
                speech.Listen();
            }
            function onResult(res, partial) {
                if (res.toLowerCase().includes("jarvis")) {
                    app.SendMessage("WakeUp");
                    app.ShowApp();
                }
                if(!partial) speech.Listen();
            }
            function onError(err) {
                speech.Listen();
            }
        `;
        app.WriteFile("Service.js", serviceCode);
        app.StartService();
    }

    findApp(appId) {
        if (!window.APP_REGISTRY) return null;
        for (const cat in APP_REGISTRY) {
            const found = APP_REGISTRY[cat].find(a => a.id === appId);
            if (found) return found;
        }
        return null;
    }
}

// Initialize DroidScript Bridge after omAI is created
window.onload = () => {
    if (window.omAI) {
        const dsBridge = new DroidScriptBridge(omAI);
        dsBridge.init();
        window.dsBridge = dsBridge;
    }
};

function OnMessage(msg) {
    if (msg === 'WakeUp') {
        if (window.omAI) window.omAI.startVoiceRecognition();
    }
}

</script></body></html>
